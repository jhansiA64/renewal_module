[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-06-13 00:39:57.378555",
  "module": "orc",
  "name": "ORC Balance Amount",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Journal Entry",
  "script": "orc = doc.orc_id\nj_amount = 0\nb_amount = 0\nif frappe.db.exists({\"doctype\": \"ORC List\", \"name\": doc.orc_id}):\n    if frappe.db.exists({\"doctype\": \"Journal Entry\", \"orc_id\": doc.orc_id}):\n        # frappe.msgprint(orc)\n        je_data = frappe.db.sql(f\"\"\"SELECT total_debit FROM `tabJournal Entry` tje where tje.orc_id = '{orc}' ;\"\"\", as_dict=1)\n        for each in je_data:\n            j_amount = j_amount + each.total_debit\n        \n        data = frappe.get_doc('ORC List', orc)\n        orc_data = frappe.db.sql(f\"\"\"SELECT sub_total FROM `tabORC List` tol where tol.name= '{orc}' ;\"\"\", as_dict=1)\n        b_amount = orc_data[0].sub_total - j_amount\n        data.balance_amount = b_amount\n        data.save()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Delete",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-06-13 00:39:57.363912",
  "module": "orc",
  "name": "ORC Balance amount (Delete )",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Journal Entry",
  "script": "j_amount = 0\nb_amount = 0\nif frappe.db.exists({\"doctype\": \"ORC List\", \"name\": doc.orc_id}):\n    orc = doc.orc_id\n    if frappe.db.exists({\"doctype\": \"Journal Entry\", \"orc_id\": doc.orc_id}):\n        # frappe.msgprint(\"exists\")\n        orc_data = frappe.db.sql(f\"\"\"SELECT sub_total FROM `tabORC List` tol where tol.name= '{orc}' ;\"\"\", as_dict=1)\n        je_data = frappe.db.sql(f\"\"\"SELECT total_debit, docstatus FROM `tabJournal Entry` tje where tje.orc_id = '{orc}' and tje.docstatus != '{2}' ;\"\"\", as_dict=1)\n        # frappe.msgprint(len(je_data))\n        if len(je_data) < 1:\n            j_amount = orc_data[0].sub_total\n        else:\n            for each in je_data:\n                if each.docstatus != 2:\n                    j_amount = j_amount + each.total_debit\n            \n        data = frappe.get_doc('ORC List', orc)\n        \n        b_amount = orc_data[0].sub_total - j_amount\n        data.balance_amount = b_amount\n        data.save()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-19 18:29:46.260127",
  "module": "Renewal Module",
  "name": "JE to GL",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Journal Entry",
  "script": "posting_date = doc.posting_date\n# frappe.msgprint(\"hello hi hi\")\ngl_data = frappe.db.sql(f\"\"\"SELECT name,posting_date, fisical_year FROM `tabGL Entry` WHERE voucher_no='{doc.name}'  ;\"\"\")\nname = gl_data[0][0]\nold_data = frappe.get_doc('GL Entry',name)\nold_data.posting_date = posting_date\ndate_list = posting_date.split(\"-\")\n# frappe.msgprint(date_list[-1])",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2023-04-06 11:30:06.320105",
  "module": "Renewal Module",
  "name": "Sales Invoice to Renewal",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Sales Invoice",
  "script": "invoice_num = doc.name\nuser = \"\"\nteam_name= \"\"\n#frappe.msgprint(doc.customer_name)\n\nif doc.sales_team.length != 0:\n    user = doc.sales_team[0].sales_person\n    team_name = doc.sales_team[0].team_name\n\n\n    \nfor d in doc.items:\n    frappe.msgprint(d.item_name)\n     \n    if d.newadd == \"Renewal\":\n       \n        if frappe.db.exists({\"doctype\": \"Renewal List\", \"customer_name\": doc.customer_name, \"product_name\": d.item_name, \"status\":\"Active\"}):\n            frappe.msgprint(doc.customer_name)\n            status_item = \"Active\"\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE status='{status_item}'AND product_name='{d.item_name}' AND customer_name='{doc.customer_name}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Renewed\"\n            old_data.save()\n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n        \n            \n            contact_status = \"Open\"\n            contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n            \n            \n            sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name, account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n            frappe.msgprint(sales_team[0][0])\n            frappe.msgprint(sales_team[0][1])\n            if renewal_option:\n                frappe.msgprint(renewal_option[0][0])\n            \n                if renewal_option[0][0] == \"Yes\":\n                    data = frappe.get_doc({\n                        'doctype': 'Renewal List',\n                        'product_name':d.item_code,\n                        'status':\"Active\",\n                        'invoice_no':invoice_num,\n                        'end_date':d.end_date,\n                        'total_quantity':d.qty,\n                        'total_amount':d.amount,\n                        'start_date':d.start_date,\n                        'customer_name':doc.customer,\n                        'sales_user' : user,\n                        'sales_team' : team_name,\n                        'renewal_owner':sales_team[0][2]\n                        \n                        \n                    })\n                    frappe.msgprint(d.item_code)\n                    \n                    data.append(\"items\",{\n                        'item_code' : d.item_code,\n                        'qty': d.qty,\n                        'start_date':d.start_date,\n                        'end_date':d.end_date,\n                        'rate':d.rate,\n                        'new_add':d.newadd,\n                        'amount':d.amount,\n                        'uom':d.uom,\n                        'description':d.description,\n                        'item_name': d.item_name,\n                        'invoice_no':invoice_num,\n                        'conversion_factor':d.conversion_factor\n                    })\n                    \n                    \n                    \n                    for each in doc.contact_list:\n                    \n                        data.append(\"contact_list\",{\n                            'user_name' : each.user_name,\n                            'mobile_no': each.mobile_no,\n                            'email_id':each.email_id,\n                            'designation':each.designation\n                            \n                        })\n                        \n                    data.insert()    \n        \n        \n        else:\n            frappe.throw(f\"Renewal item {d.item_name} is not available\")            \n    \n    \n    if d.newadd == \"Additional\":\n        if frappe.db.exists({\"doctype\": \"Renewal List\", \"customer_name\": doc.customer_name, \"product_name\": d.item_name, \"status\":\"Active\"}):\n            frappe.msgprint(doc.customer_name)\n            \n            status_item = \"Active\"\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE status='{status_item}' AND product_name='{d.item_name}' AND customer_name='{doc.customer_name}'  ;\"\"\")\n            \n            frappe.msgprint(name_field[0][0])\n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            # frappe.msgprint(old_data)\n            old_data.status = \"Active\"\n            old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n            old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n            \n            old_data.append(\"items\",{\n                'item_code' : d.item_code,\n                'qty': d.qty,\n                'start_date':d.start_date,\n                'end_date':d.end_date,\n                'rate':d.rate,\n                'new_add':d.newadd,\n                'amount':d.amount,\n                'uom':d.uom,\n                'cost_center':d.cost_center,\n                'description':d.description,\n                'item_name': d.item_name,\n                'invoice_no':doc.name,\n                'conversion_factor':d.conversion_factor\n            })\n            frappe.msgprint(\"Successfully entered Renewal\")\n            #old_data.insert()\n            old_data.save()\n            \n        else:\n            frappe.throw(f\"Please check line item {d.item_name}\")  \n            \n    if d.newadd == \"New\":\n        \n        renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n        \n        #frappe.msgprint(renewal_option[0])\n        contact_status = \"Open\"\n        contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n        # frappe.msgprint(len(contact_data))\n        \n        sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name,account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n        #frappe.msgprint(sales_team[0][0])\n        #frappe.msgprint(sales_team[0][1])\n        if renewal_option:\n            #frappe.msgprint(renewal_option[0][0])\n        \n            if renewal_option[0][0] == \"Yes\":\n                \n                \n                data = frappe.get_doc({\n                    'doctype': 'Renewal List',\n                    'product_name':d.item_name,\n                    'status':\"Active\",\n                    'invoice_no':invoice_num,\n                    'end_date':d.end_date,\n                    'total_quantity':d.qty,\n                    'total_amount':d.amount,\n                    'start_date':d.start_date,\n                    'customer_name':doc.customer,\n                    'sales_user' : user,\n                    'sales_team' : team_name,\n                    'renewal_owner':sales_team[0][2]\n                    \n                    \n                })\n                \n                    \n                #frappe.msgprint(d.item_code)\n                \n                data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':invoice_num,\n                    'conversion_factor':d.conversion_factor,\n                    'managed_services':d.managed_services\n                })\n                \n                for each in doc.contact_list:\n                    \n                    data.append(\"contact_list\",{\n                        'user_name' : each.user_name,\n                        'mobile_no': each.mobile_no,\n                        'email_id':each.email_id,\n                        'designation':each.designation,\n                        \n                    })\n                    \n                    frappe.msgprint(\"Successfully entered Renewal\")\n               \n                \n                \n                data.insert() \n        \n        else:\n            frappe.msgprint(\"This product has no subscription\")\n                \n                \n                \n                    \n            \n         ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-25 15:43:16.791955",
  "module": "Renewal Module",
  "name": "Invoice to Renewal",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Sales Invoice",
  "script": "invoice_num = doc.name\nuser = \"\"\nlead_name= \"\"\n# frappe.msgprint(doc.customer_name)\n\nif doc.sales_team.length == 0:\n    frappe.msgprint(\"Please Add Sales Team Details\")\nelse:\n    user = doc.sales_team[0].sales_person\n    lead_name = doc.sales_team[0].team_name\n    \n\n\nif doc.is_return == 0:\n    for d in doc.items:\n        # frappe.msgprint(d.newadd)\n         \n        if d.newadd == \"Renewal\" :\n            # frappe.msgprint(\"hello!!!!\")\n            if d.renewal_id != \" \":\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                #frappe.msgprint(\"hello hi hi\")\n                \n                old_data.status = \"Renewed\"\n                old_data.save()\n                renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name=\"{d.item_code}\"  ;\"\"\")\n                \n                #frappe.msgprint(renewal_option[0])\n                contact_status = \"Open\"\n                # contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n                # frappe.msgprint(len(contact_status))\n                \n                sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name, account_manager FROM `tabCustomer` WHERE  customer_name=\"{doc.customer_name}\"  ;\"\"\")\n                # frappe.msgprint(sales_team[0][0])\n                #frappe.msgprint(sales_team[0][1])\n                if renewal_option:\n                    # frappe.msgprint(renewal_option[0][0])\n            \n                    if renewal_option[0][0] == \"Yes\":\n                        data = frappe.get_doc({\n                            'doctype': 'Renewal List',\n                            'product_name':d.item_name,\n                            'status':\"Draft\",\n                            'invoice_no':invoice_num,\n                            'renewal_attachment':d.renewal_attachment,\n                            'end_date':d.end_date,\n                            'total_quantity':d.qty,\n                            'total_amount':doc.grand_total,\n                            'start_date':d.start_date,\n                            'customer_name':doc.customer,\n                            'sales_user' : user,\n                            'domain_name':old_data.domain_name,\n                            'sales_team' : sales_team[0][1],\n                            'renewal_owner':sales_team[0][2]\n                            \n                            \n                        })\n                        # frappe.msgprint(d.item_code)\n                        \n                        data.append(\"items\",{\n                            'item_code' : d.item_code,\n                            'qty': d.qty,\n                            'start_date':d.start_date,\n                            'end_date':d.end_date,\n                            'rate':d.rate,\n                            'new_add':d.newadd,\n                            'amount':d.amount,\n                            'uom':d.uom,\n                            'description':d.description,\n                            'item_name': d.item_name,\n                            'item_group':d.item_group,\n                            'renewal_id': d.renewal_id,\n                            'brand':d.brand,\n                            'invoice_no':invoice_num,\n                            'conversion_factor':d.conversion_factor\n                        })\n                        \n                        #frappe.msgprint(\"auto-entered\")\n                        \n                       \n                        \n                        if doc.contact_list:\n                            for each in doc.contact_list:\n                        \n                                data.append(\"contact_list\",{\n                                    'user_name' : each.user_name,\n                                    'mobile_no': each.mobile_no,\n                                    'email_id':each.email_id,\n                                    'designation':each.designation\n                                    \n                                })\n                        else:\n                            frappe.throw(\"Please add contact details\")\n                            \n                            \n                        data.insert()    \n                \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n           \n        if d.newadd == \"Additional\" :\n            if d.renewal_id != \" \":\n                #frappe.msgprint(name_field[0][0])\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                # frappe.msgprint(old_data)\n                old_data.status = \"Active\"\n                old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n                old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n                \n                old_data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'cost_center':d.cost_center,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'item_group':d.item_group,\n                    'brand':d.brand,\n                    'invoice_no':doc.name,\n                    'conversion_factor':d.conversion_factor\n                })\n                #old_data.insert()\n                old_data.save()\n            \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n        \n        if d.newadd == \"New\":\n            \n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n            \n            # frappe.msgprint(renewal_option[0][0])\n            contact_status = \"Open\"\n            # contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n            # frappe.msgprint(len(contact_data))\n            \n            sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name,account_manager FROM `tabCustomer` WHERE  customer_name=\"{doc.customer_name}\"  ;\"\"\")\n            # frappe.msgprint(sales_team[0][0])\n            # frappe.msgprint(sales_team[0][1])\n            if renewal_option:\n                # frappe.msgprint(renewal_option[0][0])\n            \n                if renewal_option[0][0] == \"Yes\":\n                    \n                    \n                    data = frappe.get_doc({\n                        'doctype': 'Renewal List',\n                        'product_name':d.item_name,\n                        'status':\"Draft\",\n                        'invoice_no':invoice_num,\n                        'end_date':d.end_date,\n                        'renewal_attachment':d.renewal_attachment,\n                        'total_quantity':d.qty,\n                        'total_amount':d.amount,\n                        'start_date':d.start_date,\n                        'customer_name':doc.customer,\n                        'sales_user' : user,\n                        'sales_team' : lead_name,\n                        'renewal_owner':sales_team[0][2]\n                        \n                    })\n                    \n                    \n                    # frappe.msgprint(d.item_code)\n                    \n                    data.append(\"items\",{\n                        'item_code' : d.item_code,\n                        'qty': d.qty,\n                        'start_date':d.start_date,\n                        'end_date':d.end_date,\n                        'rate':d.rate,\n                        'new_add':d.newadd,\n                        'amount':d.amount,\n                        'uom':d.uom,\n                        'description':d.description,\n                        'item_name': d.item_name,\n                        'item_group':d.item_group,\n                        'brand':d.brand,\n                        'invoice_no':invoice_num,\n                        'conversion_factor':d.conversion_factor,\n                        'managed_services':d.managed_services\n                    })\n                    \n                    \n                    if doc.contact_list:\n                        for each in doc.contact_list:\n                    \n                            data.append(\"contact_list\",{\n                                'user_name' : each.user_name,\n                                'mobile_no': each.mobile_no,\n                                'email_id':each.email_id,\n                                'designation':each.designation\n                                \n                            })\n                    else:\n                        frappe.throw(\"Please add contact details\")\n                            \n                        \n                        \n                        # frappe.msgprint(\"contact-entered\")\n                    \n                    # frappe.msgprint(\"re-entered\")\n                    \n                   \n                    \n                    \n                    data.insert() \n        \n                    \nelse:\n    for d in doc.items:\n        if d.newadd == \"New\":\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n            if renewal_option[0][0] == \"Yes\":\n                old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n                old_data.status = \"Void\"\n                old_data.save()\n        if d.newadd == \"Renewal\":\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Void\"\n            old_data.save()\n        if d.newadd == \"Additional\"   : \n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal Item` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data1 = frappe.get_doc('Renewal Item',name_field[0][0])\n            \n            old_data1.status = \"Void\"\n            old_data1.save()  \n            if d.renewal_id != \" \":\n                #frappe.msgprint(name_field[0][0])\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                # frappe.msgprint(old_data)\n                old_data.status = \"Active\"\n                old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n                old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n                \n                old_data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'cost_center':d.cost_center,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'item_group':d.item_group,\n                    'brand':d.brand,\n                    'invoice_no':doc.name,\n                    'status':\"Void\",\n                    'conversion_factor':d.conversion_factor\n                })\n                #old_data.insert()\n                old_data.save()\n            \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n     ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-06-13 00:40:44.279631",
  "module": "Renewal Module",
  "name": "cof to renewal status",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Customer Order Form",
  "script": "for d in doc.items:\n    if d.opportunity_type == \"Renewal\":\n        if d.renewal_id != \" \":\n            old_data = frappe.get_doc('Renewal List',d.renewal_id)\n            old_data.status = \"Cofed\"\n            old_data.save()\n        else:\n            frappe.throw(f\"Please check Renewal ID\")    \n        \n     ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-06 11:03:59.814218",
  "module": "Renewal Module",
  "name": "COF and Supplier Quote",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Customer Order Form",
  "script": "for d in doc.items:\n    # frappe.msgprint(\"hello\")\n    \n    quote_data = frappe.db.sql(f\"\"\"SELECT \n    top.sq_name as name ,top.status,\n    (case when top.p_rate IS NOT NULL THEN top.p_rate\n    else 0 END) as purchase_rate,\n    (case when top.p_amount IS NOT NULL THEN top.p_amount\n    else 0 END) as purchase_amount,\n    top.supplier as supplier\n    FROM `tabQuotation Item` tqi\n    LEFT JOIN (SELECT toi.parent as opportunity,tpq.status as status,toi.name , toi.item_code as s_item_code ,\n    tpq.name as sq_name, tpq.item_code as sq_item_code,\n        toi.rate as s_rate , tpq.rate as p_rate ,tpq.qty as p_qty, \n        tpq.amount as p_amount, tpq.supplier as supplier\n        from \n        `tabOpportunity Item` toi\n        left join (SELECT tsq.name as name ,tsq.status as status, \n        tsq.Supplier as supplier , tsqi.item_code as item_code ,\n        tsqi.rate as rate , tsqi.qty as qty, tsqi.amount as amount, tsq.opportunity as opportunity,tsqi.opportunity_item as opp_item\n        from `tabSupplier Quotation` tsq  \n        left join (SELECT parent , item_code , rate, qty, amount ,opportunity_item  \n        FROM `tabSupplier Quotation Item`  WHERE recommended_ =1\n        ) as tsqi on tsqi.parent = tsq.name \n        ) as tpq on tpq.opportunity = toi.parent and toi.item_code = tpq.item_code and toi.qty = tpq.qty and tpq.opp_item = toi.name\n        ) as top on top.opportunity = tqi.prevdoc_docname and top.s_item_code = tqi.item_code and top.p_qty = tqi.qty and tqi.rate = top.s_rate\n    WHERE tqi.parent = '{doc.quotation_id}' and tqi.item_code= '{d.item_code}' and tqi.qty ='{d.qty}' and tqi.rate = '{d.rate}' ;\"\"\",as_dict =1 )\n    \n   #to get orc amount\n    orc_data = frappe.db.sql(f\"\"\"SELECT torc.commission_amount as orc_amount,\n            torc.orc_id as orc, toi.orc as orc_value\n            FROM `tabQuotation Item` tqi\n            left join `tabOpportunity Item` toi on tqi.prevdoc_docname = toi.parent and tqi.qty = toi.qty  and toi.rate = tqi.rate and toi.description = tqi.description\n\t\t\tLEFT JOIN \n\t\t\t\t(SELECT toi2.commission_amount as commission_amount, tol.name as orc_id,\n\t\t\t\ttol.opportunity_id as opportunity_id,\n\t\t\t\ttoi2.item_code as item_code , toi2.qty as qty ,\n\t\t\t\ttoi2.rate as rate , toi2.description as description \n\t\t\t\tFROM `tabORC Item` toi2 \n\t\t\t    left join `tabORC List` tol on toi2.parent = tol.name\tWHERE tol.docstatus  in(0, 1) and tol.workflow_state not in ('Duplicate','Cancelled') and tol.status != \"Duplicate\"\n\t\t\t    ) as torc on  torc.opportunity_id = toi.parent and toi.item_code = torc.item_code \n\t\t\t\tand toi.qty = torc.qty and toi.rate = torc.rate and toi.description = torc.description\n\t\t\tWHERE tqi.parent = '{doc.quotation_id}' and tqi.item_code= '{d.item_code}' and tqi.qty ='{d.qty}' ;\"\"\",as_dict =1\t\n\t\t\t)\n    \n    \n    old_data = frappe.get_doc('Customer Order Form Item',d.name)\n    old_data.purchase_rate = quote_data[0].purchase_rate\n    old_data.purchase_amount = quote_data[0].purchase_amount\n    old_data.supplier_quotation = quote_data[0].name\n    old_data.supplier = quote_data[0].supplier\n    # old_data.margin_amount = round(float(d.amount) - float(quote_data[0].purchase_amount),2)\n    margin = 0\n    \n    if quote_data[0].name != \" \":\n        margin = margin +round(float(d.amount) - float(quote_data[0].purchase_amount),2) \n        current_datetime = frappe.utils.today()\n        new_datetime = frappe.utils.add_to_date(current_datetime, days=10, as_string=True)\n        \n        sq_data = frappe.get_doc('Supplier Quotation',quote_data[0].name)\n        sq_data.cof_id = doc.name\n        sq_data.valid_till = new_datetime\n        if sq_data.status == \"Expired\":\n            sq_data.status = \"Draft\"\n        sq_data.save()\n    else:\n        frappe.throw(f\"Please check Supplier Quotation\") \n    \n    if orc_data[0].orc_value == 1 and orc_data[0].orc != \" \":\n        # frappe.msgprint(\"ORC\")\n        margin = margin - round(float(orc_data[0].orc_amount),2)\n        old_data.orc = 1\n        old_data.orc_id = orc_data[0].orc\n        old_data.orc_amount = orc_data[0].orc_amount\n        # frappe.msgprint(orc_data[0].orc)\n        \n        orc_list = frappe.get_doc('ORC List',orc_data[0].orc)\n        orc_list.cof_id = doc.name\n        # orc_list.valid_till = new_datetime\n        # orc_list.status = \"Draft\"\n        orc_list.save()\n    elif orc_data[0].orc_value == 1 and orc_data[0].orc == \" \": \n        frappe.throw(f\"Please Create the ORC\")\n    old_data.margin_amount = margin    \n    \n        \n    \n    old_data.save()\n    \n    \n    \n    \n    \n    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-06-13 00:39:57.348078",
  "module": "orc",
  "name": "ORC Margin Details",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "ORC List",
  "script": "# doc.set(\"custom_orc_margin_table\", [])\nfor each in doc.items:\n    \n    p_data = frappe.db.sql(f\"\"\"\n        SELECT (case when tpq.rate IS NOT NULL THEN tpq.rate\n        else 0 END) as purchase_rate,\n        (case when tpq.amount IS NOT NULL THEN tpq.amount\n        else 0 END) as purchase_amount\n        from \n        `tabOpportunity Item` toi\n        left join (SELECT tsq.name as name  , tsqi.item_code as item_code , tsqi.rate as rate,tsqi.amount as amount ,\n        tsq.opportunity as opportunity, tsq.description as description\n        from `tabSupplier Quotation` tsq  \n        left join (SELECT parent , item_code , rate, amount,description  FROM `tabSupplier Quotation Item`  WHERE recommended_ =1) as tsqi on tsqi.parent = tsq.name \n        ) as tpq on tpq.opportunity = toi.parent and toi.item_code = tpq.item_code and tpq.description = toi.description\n        WHERE toi.parent = '{doc.opportunity_id}' and toi.item_code= '{each.item_code}' and toi.rate= '{each.rate}' and toi.qty ='{each.qty}' ;\"\"\",as_dict =1)\n    \n    # frappe.msgprint(float(each.amount) - float(p_data[0].purchase_amount))\n    old_data = frappe.get_doc('ORC Item',each.name)\n    old_data.purchase_rate = p_data[0].purchase_rate\n    old_data.purchase_amount = p_data[0].purchase_amount\n    old_data.margin = float(each.amount) - float(p_data[0].purchase_amount)\n    # old_data.margin_amount = float(each.amount) \n    \n    old_data.save()\n\n# for each in doc.custom_orc_margin_table: \n#     p_data = frappe.db.sql(f\"\"\"\n#         SELECT (case when tpq.rate IS NOT NULL THEN tpq.rate\n#         else 0 END) as purchase_rate,\n#         (case when tpq.amount IS NOT NULL THEN tpq.amount\n#         else 0 END) as purchase_amount\n#         from \n#         `tabOpportunity Item` toi\n#         left join (SELECT tsq.name as name  , tsqi.item_code as item_code , tsqi.rate as rate,tsqi.amount as amount , tsq.opportunity as opportunity\n#         from `tabSupplier Quotation` tsq  \n#         left join (SELECT parent , item_code , rate, amount  FROM `tabSupplier Quotation Item`  WHERE recommended_ =1) as tsqi on tsqi.parent = tsq.name \n#         ) as tpq on tpq.opportunity = toi.parent and toi.item_code = tpq.item_code\n#         WHERE toi.parent = '{doc.opportunity_id}' and toi.item_code= '{each.item_code}'  and toi.rate= '{each.selling_rate}' and toi.qty ='{each.qty}' ;\"\"\",as_dict =1)\n    \n#     margin_data = frappe.get_doc('ORC Margin Table',each.name)\n#     margin_data.buying_rate = p_data[0].purchase_rate\n#     margin_data.buying_amount = p_data[0].purchase_amount\n#     margin_data.margin = float(each.selling_amount) - float(p_data[0].purchase_amount)\n     \n    \n#     margin_data.save()\n        \n    \n  ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-06-13 00:39:57.330387",
  "module": "orc",
  "name": "Invoice To ORC Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "if doc.items:\n    for each in doc.items:\n        if each.ord_id:\n            orc_data = frappe.get_doc('ORC List',each.orc_id)\n            orc_data.status = \"Waiting For Payment\"\n            orc_data.workflow_state=\"Waiting For Payment\"\n            orc_data.save()\n            frappe.msgprint(\"ORC Status Changed\")\n                ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-06-13 00:39:57.293130",
  "module": "orc",
  "name": "Payment Entry To ORC Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Payment Entry",
  "script": "if doc.references:\n    for each in doc.references:\n        if each.reference_doctype == \"Sales Invoice\" and each.reference_name:\n            orc_list = []\n            # frappe.msgprint(\"entered\")\n            sales_invoice = frappe.get_doc('Sales Invoice',each.reference_name)\n            \n            data = sales_invoice.grand_total\n            # frappe.msgprint(data)\n            item_data = frappe.db.sql(f\"\"\"SELECT name,orc_id FROM `tabSales Invoice Item` WHERE  parent='{each.reference_name}'  ;\"\"\",as_dict=1)\n            \n            for i in item_data:\n                if i.orc_id:\n                    if i.orc_id in orc_list:\n                        pass\n                    else:\n                        orc_list.append(i.orc_id)\n            # frappe.msgprint(invoice_data[0][1])\n            if len(orc_list) >0 and sales_invoice.outstanding_amount == 0:\n                for r in orc_list:\n                    orc_data = frappe.get_doc('ORC List',r)\n                    orc_data.status = \"Payout\"\n                    orc_data.workflow_state=\"Payout\"\n                    orc_data.save()\n                    frappe.msgprint(\"ORC Status Changed\")\n                ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-19 18:29:03.199604",
  "module": "Renewal Module",
  "name": "Email Group",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Email Group",
  "script": "\nif doc.custom_filters_table:\n    data = frappe.db.sql(f\"\"\"\n        SELECT eg.name, ft.doctypes, ft.field_name, ft.condition, ft.value, ft.and_or_condition\n        FROM `tabEmail Group` AS eg\n        LEFT JOIN `tabFilters Table` AS ft ON eg.name = ft.parent\n        WHERE eg.name = %s\n    \"\"\", (doc.name,))\n\n    # Process the data to create the formatted string\n    if data:\n        details = []\n        doctype_list = []\n        joins = \"\"\n        join_list = []\n        for row in data:\n            doctypes = row[1]\n            doctype_list.append(doctypes)\n            field_name = row[2]\n            condition = row[3]\n            value = row[4]\n            and_or = row[5]\n            value = value.replace('\\n', ',')\n            frappe.msgprint(doctypes)\n\n            # Split values and format them\n            value_list = [v.strip() for v in value.split(',') if v.strip()]\n            formatted_values = \", \".join([f\"'{v}'\" for v in value_list])\n            details.append(f\" {and_or} `tab{doctypes}`.{field_name} {condition} ({formatted_values})\")\n            frappe.msgprint(formatted_values)\n\n            # Construct joins based on doctypes\n            if doctypes == \"Customer\":\n                pass\n            # elif doctypes == \"Sales Person\":\n            #     joins += f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Team`.sales_person \"\n            elif doctypes == \"Opportunity\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Quotation\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Sales Order\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Sales Invoice\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Customer Order Form\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n                             \n            elif doctypes == \"Renewal List\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tab{doctypes}`.name\n                             LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Territory\":\n                frappe.msgprint(\"territory\")\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.territory \"\"\")\n            \n            elif doctypes == \"Industry Type\":\n                join_list.append(f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.industry \")\n\n            if doctypes == \"Item\" and \"Sales Invoice\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.item_code \"\"\")\n                \n            if doctypes == \"Item\" and \"Sales Order\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.item_code \"\"\")\n                \n            # if doctypes == \"Item\" and \"Renewal List\" in doctype_list:\n            #     join_list.append(f\"\"\"LEFT JOIN `tabRenewal List` ON `tabRenewal List`.customer_name = `tabCustomer`.name\n            #                  LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tabRenewal List`.name\n            #                  LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tabRenewal List`.name\n            #                  LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.item_code \"\"\")\n            \n            if doctypes == \"Item\" and \"Renewal List\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.item_code \"\"\")\n            \n            \n            \n            \n            if doctypes == \"Brand\" and \"Sales Invoice\" in doctype_list:\n                frappe.msgprint(\"brand\")\n                frappe.msgprint(joins)\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.brand \"\"\")\n                \n            if doctypes == \"Brand\" and \"Sales Order\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.brand \"\"\")\n                \n            if doctypes == \"Brand\" and \"Renewal List\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.brand \"\"\")\n\n        formatted_output = \" \".join(details)\n        join_output = \"\\n \".join(join_list)\n        frappe.msgprint(formatted_output)\n\n        # Fetch contacts based on the joins and conditions\n        s_contacts = frappe.db.sql(f\"\"\"\n            SELECT DISTINCT `tabContact`.name as contact_person, `tabContact`.email_id as email, `tabCustomer`.territory,`tabCustomer`.name as customer\n            FROM `tabContact`\n            LEFT JOIN `tabDynamic Link` ON `tabContact`.name = `tabDynamic Link`.parent\n            LEFT JOIN `tabCustomer` ON `tabDynamic Link`.link_name = `tabCustomer`.name\n            LEFT JOIN `tabSales Team` ON `tabSales Team`.parent = `tabCustomer`.name\n            LEFT JOIN `tabSales Person` ON `tabSales Team`.sales_person = `tabSales Person`.name\n            {join_output}\n            WHERE `tabContact`.status = \"Open\" {formatted_output};\n        \"\"\", as_dict=True)\n        \n        frappe.msgprint(f\"Total contacts found: {len(s_contacts)}\")\n        added_emails = set()\n\n\n        for each in s_contacts:\n            frappe.msgprint(each.email)\n            if each.email and each.email not in added_emails:\n                if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email,\"email_group\": doc.name}):\n                    frappe.get_doc({\n                        \"doctype\": \"Email Group Member\",\n                        \"email_group\":doc.name,\n                        \"email\": each.email,\n                        \"custom_customer_name\":each.customer,\n                        \"custom_contact_person\":each.contact_person\n                    }).insert()\n                    added_emails.add(each.email)\n\n        filters = {\n            \"email_group\": doc.name\n        }\n\n        fields = [\"name\"]\n\n        members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n\n        doc.total_subscribers = len(members)\n    else:\n        frappe.msgprint(\"No data found in the filters table.\")\n",
  "script_type": "DocType Event"
 }
]