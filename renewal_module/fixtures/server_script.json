[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-10-15 10:56:01.633851",
  "module": null,
  "name": "COF and Supplier Quote",
  "reference_doctype": "Customer Order Form",
  "script": "\nfor d in doc.items:\n    # frappe.msgprint(\"hello\")\n    \n    quote_data = frappe.db.sql(f\"\"\"SELECT \n    top.sq_name as name ,\n    (case when top.p_rate IS NOT NULL THEN top.p_rate\n    else 0 END) as purchase_rate,\n    (case when top.p_amount IS NOT NULL THEN top.p_amount\n    else 0 END) as purchase_amount,\n    top.supplier as supplier\n    FROM `tabQuotation Item` tqi\n    LEFT JOIN (SELECT toi.parent as opportunity,toi.name , toi.item_code as s_item_code ,tpq.name as sq_name, tpq.item_code as sq_item_code,\n        toi.rate as s_rate , tpq.rate as p_rate ,tpq.qty as p_qty, tpq.amount as p_amount, tpq.supplier as supplier\n        from \n        `tabOpportunity Item` toi\n        left join (SELECT tsq.name as name , tsq.Supplier as supplier , tsqi.item_code as item_code , tsqi.rate as rate , tsqi.qty as qty, tsqi.amount as amount, tsq.opportunity as opportunity\n        from `tabSupplier Quotation` tsq  \n        left join (SELECT parent , item_code , rate, qty, amount   FROM `tabSupplier Quotation Item`  WHERE recommended_ =1) as tsqi on tsqi.parent = tsq.name \n        ) as tpq on tpq.opportunity = toi.parent and toi.item_code = tpq.item_code) as top on top.opportunity = tqi.prevdoc_docname and top.s_item_code = tqi.item_code \n    WHERE tqi.parent = '{doc.quotation_id}' and tqi.item_code= '{d.item_code}' and tqi.qty ='{d.qty}' ;\"\"\",as_dict =1 )\n    \n    #to get orc amount\n    orc_data = frappe.db.sql(f\"\"\"SELECT torc.commission_amount as orc_amount,\n            torc.orc_id as orc, toi.orc as orc_value\n            FROM `tabQuotation Item` tqi\n            left join `tabOpportunity Item` toi on tqi.prevdoc_docname = toi.parent and tqi.qty = toi.qty  and toi.rate = tqi.rate and tqi.description = toi.description\n\t\t\tLEFT JOIN \n\t\t\t\t(SELECT toi2.commission_amount as commission_amount, tol.name as orc_id,\n\t\t\t\ttol.opportunity_id as opportunity_id,\n\t\t\t\ttoi2.item_code as item_code , toi2.qty as qty ,\n\t\t\t\ttoi2.rate as rate , toi2.description as description \n\t\t\t\tFROM `tabORC Item` toi2 \n\t\t\t    left join `tabORC List` tol on toi2.parent = tol.name\tWHERE tol.docstatus  = 1 and tol.status != \"Duplicate\"\n\t\t\t    ) as torc on  torc.opportunity_id = toi.parent and toi.item_code = torc.item_code \n\t\t\t\tand toi.qty = torc.qty and toi.rate = torc.rate and toi.description = torc.description\n\t\t\tWHERE tqi.parent = '{doc.quotation_id}' and tqi.item_code= '{d.item_code}' and tqi.qty ='{d.qty}' ;\"\"\",as_dict =1\t\n\t\t\t)\n    \n    \n    \n\n    \n    # frappe.msgprint(quote_data[])\n    # frappe.msgprint(quote_data[0].name)\n    # frappe.msgprint(quote_data[0].purchase_rate)\n    # frappe.msgprint(quote_data[0].purchase_amount)\n    # frappe.msgprint(\"<pre>{}</pre>\".format(frappe.as_json(quote_data)))\n    # frappe.msgprint(\"hi\")\n    old_data = frappe.get_doc('Customer Order Form Item',d.name)\n    old_data.purchase_rate = quote_data[0].purchase_rate\n    old_data.purchase_amount = quote_data[0].purchase_amount\n    old_data.supplier_quotation = quote_data[0].name\n    old_data.supplier = quote_data[0].supplier\n    margin = 0\n    \n    if quote_data[0].name != \" \":\n        margin = margin +round(float(d.amount) - float(quote_data[0].purchase_amount),2)\n        \n        date = frappe.utils.nowdate()\n        current_datetime = frappe.utils.today()\n        new_datetime = frappe.utils.add_to_date(current_datetime, days=10, as_string=True)\n        # frappe.msgprint(new_datetime)\n        \n        sq_data = frappe.get_doc('Supplier Quotation',quote_data[0].name)\n        sq_data.cof_id = doc.name\n        sq_data.valid_till = new_datetime\n        sq_data.status = \"Draft\"\n        sq_data.save()\n        \n    else:\n        frappe.throw(f\"Please check Supplier Quotation\")\n    frappe.msgprint(margin)    \n    \n    if orc_data[0].orc_value == 1 and orc_data[0].orc != \" \":\n        # frappe.msgprint(\"ORC\")\n        margin = margin - round(float(orc_data[0].orc_amount),2)\n        old_data.orc = 1\n        old_data.orc_id = orc_data[0].orc\n        old_data.orc_amount = orc_data[0].orc_amount\n        # frappe.msgprint(orc_data[0].orc)\n        \n        orc_list = frappe.get_doc('ORC List',orc_data[0].orc)\n        orc_list.cof_id = doc.name\n        # orc_list.valid_till = new_datetime\n        # orc_list.status = \"Draft\"\n        orc_list.save()\n    elif orc_data[0].orc_value == 1 and orc_data[0].orc == \" \": \n        frappe.throw(f\"Please Create the ORC\")\n    frappe.msgprint(margin)    \n    \n    old_data.margin_amount = margin    \n    \n    old_data.save()\n    \n    \ndoc.reload()    \n    \n    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "event_frequency": "All",
  "modified": "2024-03-15 18:26:50.918654",
  "module": null,
  "name": "JE to GL",
  "reference_doctype": "Journal Entry",
  "script": "posting_date = doc.posting_date\nfrappe.msgprint(\"hello hi hi\")\ngl_data = frappe.db.sql(f\"\"\"SELECT name,posting_date, fisical_year FROM `tabGL Entry` WHERE voucher_no='{doc.name}'  ;\"\"\")\nname = gl_data[0][0]\nold_data = frappe.get_doc('GL Entry',name)\nold_data.posting_date = posting_date\ndate_list = posting_date.split(\"-\")\nfrappe.msgprint(date_list[-1])\n\n\n# SELECT tcof.name , tcofi.item_code,tcofi.name, tcofi.qty, tqi.qty, tqi.rate,\n# (CASE when top.p_qty IS NULL  then 0 \n# \t\t\telse top.p_qty END )as purchase_qty ,\n# \t\t\t(CASE when top.p_rate IS NULL  then 0 \n# \t\t\telse top.p_rate END )as purchase_rate,\n# \t\t\t(CASE when top.p_amount IS NULL  then 0 \n# \t\t\telse top.p_amount END )as purchase_amount\n# FROM `tabCustomer Order Form Item` tcofi \n# inner join `tabCustomer Order Form` tcof on tcof.name = tcofi.parent \n# LEFT JOIN `tabQuotation Item` tqi on tcof.quotation_id = tqi.parent and tcofi.item_code = tqi.item_code and tcofi.rate= tqi.rate and \n# tcofi.qty=tqi.qty\n# LEFT JOIN (SELECT toi.parent as opportunity,toi.name , toi.item_code as s_item_code ,tpq.name as sq_name, tpq.item_code as sq_item_code,\n# toi.rate as s_rate ,toi.qty as qty, tpq.rate as p_rate ,tpq.qty as p_qty, tpq.amount as p_amount, tpq.description as description\n# from \n# `tabOpportunity Item` toi\n# left join (SELECT tsq.name as name  , tsqi.item_code as item_code , tsqi.rate as rate, tsqi.description as description , tsqi.qty as qty, tsqi.amount as amount, tsq.opportunity as opportunity\n# from `tabSupplier Quotation` tsq  \n# left join (SELECT parent , item_code , rate, qty, amount, description   FROM `tabSupplier Quotation Item`  WHERE recommended_ =1) as tsqi on tsqi.parent = tsq.name \n# ) as tpq on tpq.opportunity = toi.parent and toi.item_code = tpq.item_code and toi.qty = tpq.qty) as top on \n# top.opportunity = tqi.prevdoc_docname and top.s_item_code = tqi.item_code and top.description = tqi.description and top.qty = tqi.qty and tqi.rate= top.s_rate\n# WHERE tcof.creation >= \"2023-04-01\" AND tcof.creation <= \"2024-03-31\"\n# GROUP BY tcofi.name \n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-04-06 11:30:06.320105",
  "module": "Renewal Module",
  "name": "Sales Invoice to Renewal",
  "reference_doctype": "Sales Invoice",
  "script": "invoice_num = doc.name\nuser = \"\"\nteam_name= \"\"\n#frappe.msgprint(doc.customer_name)\n\nif doc.sales_team.length != 0:\n    user = doc.sales_team[0].sales_person\n    team_name = doc.sales_team[0].team_name\n\n\n    \nfor d in doc.items:\n    frappe.msgprint(d.item_name)\n     \n    if d.newadd == \"Renewal\":\n       \n        if frappe.db.exists({\"doctype\": \"Renewal List\", \"customer_name\": doc.customer_name, \"product_name\": d.item_name, \"status\":\"Active\"}):\n            frappe.msgprint(doc.customer_name)\n            status_item = \"Active\"\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE status='{status_item}'AND product_name='{d.item_name}' AND customer_name='{doc.customer_name}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Renewed\"\n            old_data.save()\n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n        \n            \n            contact_status = \"Open\"\n            contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n            \n            \n            sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name, account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n            frappe.msgprint(sales_team[0][0])\n            frappe.msgprint(sales_team[0][1])\n            if renewal_option:\n                frappe.msgprint(renewal_option[0][0])\n            \n                if renewal_option[0][0] == \"Yes\":\n                    data = frappe.get_doc({\n                        'doctype': 'Renewal List',\n                        'product_name':d.item_code,\n                        'status':\"Active\",\n                        'invoice_no':invoice_num,\n                        'end_date':d.end_date,\n                        'total_quantity':d.qty,\n                        'total_amount':d.amount,\n                        'start_date':d.start_date,\n                        'customer_name':doc.customer,\n                        'sales_user' : user,\n                        'sales_team' : team_name,\n                        'renewal_owner':sales_team[0][2]\n                        \n                        \n                    })\n                    frappe.msgprint(d.item_code)\n                    \n                    data.append(\"items\",{\n                        'item_code' : d.item_code,\n                        'qty': d.qty,\n                        'start_date':d.start_date,\n                        'end_date':d.end_date,\n                        'rate':d.rate,\n                        'new_add':d.newadd,\n                        'amount':d.amount,\n                        'uom':d.uom,\n                        'description':d.description,\n                        'item_name': d.item_name,\n                        'invoice_no':invoice_num,\n                        'conversion_factor':d.conversion_factor\n                    })\n                    \n                    \n                    \n                    for each in doc.contact_list:\n                    \n                        data.append(\"contact_list\",{\n                            'user_name' : each.user_name,\n                            'mobile_no': each.mobile_no,\n                            'email_id':each.email_id,\n                            'designation':each.designation\n                            \n                        })\n                        \n                    data.insert()    \n        \n        \n        else:\n            frappe.throw(f\"Renewal item {d.item_name} is not available\")            \n    \n    \n    if d.newadd == \"Additional\":\n        if frappe.db.exists({\"doctype\": \"Renewal List\", \"customer_name\": doc.customer_name, \"product_name\": d.item_name, \"status\":\"Active\"}):\n            frappe.msgprint(doc.customer_name)\n            \n            status_item = \"Active\"\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE status='{status_item}' AND product_name='{d.item_name}' AND customer_name='{doc.customer_name}'  ;\"\"\")\n            \n            frappe.msgprint(name_field[0][0])\n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            # frappe.msgprint(old_data)\n            old_data.status = \"Active\"\n            old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n            old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n            \n            old_data.append(\"items\",{\n                'item_code' : d.item_code,\n                'qty': d.qty,\n                'start_date':d.start_date,\n                'end_date':d.end_date,\n                'rate':d.rate,\n                'new_add':d.newadd,\n                'amount':d.amount,\n                'uom':d.uom,\n                'cost_center':d.cost_center,\n                'description':d.description,\n                'item_name': d.item_name,\n                'invoice_no':doc.name,\n                'conversion_factor':d.conversion_factor\n            })\n            frappe.msgprint(\"Successfully entered Renewal\")\n            #old_data.insert()\n            old_data.save()\n            \n        else:\n            frappe.throw(f\"Please check line item {d.item_name}\")  \n            \n    if d.newadd == \"New\":\n        \n        renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n        \n        #frappe.msgprint(renewal_option[0])\n        contact_status = \"Open\"\n        contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n        # frappe.msgprint(len(contact_data))\n        \n        sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name,account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n        #frappe.msgprint(sales_team[0][0])\n        #frappe.msgprint(sales_team[0][1])\n        if renewal_option:\n            #frappe.msgprint(renewal_option[0][0])\n        \n            if renewal_option[0][0] == \"Yes\":\n                \n                \n                data = frappe.get_doc({\n                    'doctype': 'Renewal List',\n                    'product_name':d.item_name,\n                    'status':\"Active\",\n                    'invoice_no':invoice_num,\n                    'end_date':d.end_date,\n                    'total_quantity':d.qty,\n                    'total_amount':d.amount,\n                    'start_date':d.start_date,\n                    'customer_name':doc.customer,\n                    'sales_user' : user,\n                    'sales_team' : team_name,\n                    'renewal_owner':sales_team[0][2]\n                    \n                    \n                })\n                \n                    \n                #frappe.msgprint(d.item_code)\n                \n                data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':invoice_num,\n                    'conversion_factor':d.conversion_factor,\n                    'managed_services':d.managed_services\n                })\n                \n                for each in doc.contact_list:\n                    \n                    data.append(\"contact_list\",{\n                        'user_name' : each.user_name,\n                        'mobile_no': each.mobile_no,\n                        'email_id':each.email_id,\n                        'designation':each.designation,\n                        \n                    })\n                    \n                    frappe.msgprint(\"Successfully entered Renewal\")\n               \n                \n                \n                data.insert() \n        \n        else:\n            frappe.msgprint(\"This product has no subscription\")\n                \n                \n                \n                    \n            \n         ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-08-09 21:44:00.329043",
  "module": "Renewal Module",
  "name": "Invoice to Renewal",
  "reference_doctype": "Sales Invoice",
  "script": "invoice_num = doc.name\nuser = \"\"\nlead_name= \"\"\nfrappe.msgprint(doc.customer_name)\n\nif doc.sales_team.length != 0:\n    user = doc.sales_team[0].sales_person\n    lead_name = doc.sales_team[0].team_name\n\n\nif doc.is_return == 0:\n    for d in doc.items:\n        frappe.msgprint(d.newadd)\n         \n        if d.newadd == \"Renewal\" :\n            frappe.msgprint(d.renewal_attachment)\n            if d.renewal_id != \" \" and d.renewal_attachement != \" \":\n                frappe.msgprint(d.renewal_attachement)\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                frappe.msgprint(\"hello hi hi\")\n                \n                old_data.status = \"Renewed\"\n                old_data.save()\n                renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n                \n                #frappe.msgprint(renewal_option[0])\n                contact_status = \"Open\"\n                contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n                # frappe.msgprint(len(contact_data))\n                \n                sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name, account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n                frappe.msgprint(sales_team[0][0])\n                #frappe.msgprint(sales_team[0][1])\n                if renewal_option:\n                    frappe.msgprint(renewal_option[0][0])\n            \n                    if renewal_option[0][0] == \"Yes\":\n                        data = frappe.get_doc({\n                            'doctype': 'Renewal List',\n                            'product_name':d.item_name,\n                            'status':\"Draft\",\n                            'invoice_no':invoice_num,\n                            'end_date':d.end_date,\n                            'total_quantity':d.qty,\n                            'total_amount':doc.grand_total,\n                            'start_date':d.start_date,\n                            'customer_name':doc.customer,\n                            'sales_user' : user,\n                            'domain_name':old_data.domain_name,\n                            'sales_team' : sales_team[0][1],\n                            'renewal_owner':sales_team[0][2],\n                            'renewal_attachment':d.renewal_attachment,\n                            \n                            \n                        })\n                        frappe.msgprint(d.item_code)\n                        \n                        data.append(\"items\",{\n                            'item_code' : d.item_code,\n                            'qty': d.qty,\n                            'start_date':d.start_date,\n                            'end_date':d.end_date,\n                            'rate':d.rate,\n                            'new_add':d.newadd,\n                            'amount':d.amount,\n                            'uom':d.uom,\n                            'description':d.description,\n                            'item_name': d.item_name,\n                            'invoice_no':invoice_num,\n                            'conversion_factor':d.conversion_factor\n                        })\n                        \n                        #frappe.msgprint(\"auto-entered\")\n                        \n                       \n                        \n                        for each in doc.contact_list:\n                        \n                            data.append(\"contact_list\",{\n                                'user_name' : each.user_name,\n                                'mobile_no': each.mobile_no,\n                                'email_id':each.email_id,\n                                'designation':each.designation\n                                \n                            })\n                            \n                        data.insert()    \n                \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n           \n        if d.newadd == \"Additional\" :\n            if d.renewal_id != \" \":\n                #frappe.msgprint(name_field[0][0])\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                # frappe.msgprint(old_data)\n                old_data.status = \"Active\"\n                old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n                old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n                \n                old_data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'cost_center':d.cost_center,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':doc.name,\n                    'conversion_factor':d.conversion_factor\n                })\n                #old_data.insert()\n                old_data.save()\n            \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n        \n        if d.newadd == \"New\":\n            \n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n            \n            #frappe.msgprint(renewal_option[0])\n            contact_status = \"Open\"\n            contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n            # frappe.msgprint(len(contact_data))\n            \n            sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name,account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n            frappe.msgprint(sales_team[0][0])\n            frappe.msgprint(sales_team[0][1])\n            if renewal_option:\n                frappe.msgprint(renewal_option[0][0])\n            \n                if renewal_option[0][0] == \"Yes\":\n                    \n                    \n                    data = frappe.get_doc({\n                        'doctype': 'Renewal List',\n                        'product_name':d.item_name,\n                        'status':\"Active\",\n                        'invoice_no':invoice_num,\n                        'end_date':d.end_date,\n                        'total_quantity':d.qty,\n                        'total_amount':d.amount,\n                        'start_date':d.start_date,\n                        'customer_name':doc.customer,\n                        'sales_user' : user,\n                        'sales_team' : lead_name,\n                        'renewal_owner':sales_team[0][2],\n                        'renewal_attachment':d.renewal_attachment\n                        \n                    \n                    \n                    \n                        \n                        \n                    })\n                    \n                        \n                    frappe.msgprint(d.item_code)\n                    \n                    data.append(\"items\",{\n                        'item_code' : d.item_code,\n                        'qty': d.qty,\n                        'start_date':d.start_date,\n                        'end_date':d.end_date,\n                        'rate':d.rate,\n                        'new_add':d.newadd,\n                        'amount':d.amount,\n                        'uom':d.uom,\n                        'description':d.description,\n                        'item_name': d.item_name,\n                        'invoice_no':invoice_num,\n                        'conversion_factor':d.conversion_factor,\n                        'managed_services':d.managed_services\n                    })\n                    \n                    for each in doc.contact_list:\n                        \n                        data.append(\"contact_list\",{\n                            'user_name' : each.user_name,\n                            'mobile_no': each.mobile_no,\n                            'email_id':each.email_id,\n                            'designation':each.designation,\n                            \n                        })\n                        \n                        frappe.msgprint(\"contact-entered\")\n                    \n                    frappe.msgprint(\"re-entered\")\n                    \n                   \n                    \n                    \n                    data.insert() \nelse:\n    for d in doc.items:\n        if d.newadd == \"New\":\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Void\"\n            old_data.save()\n        if d.newadd == \"Renewal\":\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Void\"\n            old_data.save()\n        if d.newadd == \"Additional\"   : \n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal Item` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data1 = frappe.get_doc('Renewal Item',name_field[0][0])\n            \n            old_data1.status = \"Void\"\n            old_data1.save()  \n            if d.renewal_id != \" \":\n                #frappe.msgprint(name_field[0][0])\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                # frappe.msgprint(old_data)\n                old_data.status = \"Active\"\n                old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n                old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n                \n                old_data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'cost_center':d.cost_center,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':doc.name,\n                    'status':\"Void\",\n                    'conversion_factor':d.conversion_factor\n                })\n                #old_data.insert()\n                old_data.save()\n            \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n     ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2024-09-16 11:34:06.361734",
  "module": "Renewal Module",
  "name": "cof to renewal status",
  "reference_doctype": "Customer Order Form",
  "script": "for d in doc.items:\n    if d.opportunity_type == \"Renewal\":\n        if d.renewal_id != \" \":\n            old_data = frappe.get_doc('Renewal List',d.renewal_id)\n            old_data.status = \"Cofed\"\n            old_data.save()\n        else:\n            frappe.throw(f\"Please check Renewal ID\")  \nif doc.quotation_id:\n    quote_data = frappe.get_doc('Quotation',d.quotation_id)\n    quote_data.status = \"Cofed\"\n    quote_data.save()\n        \n     ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-09-28 17:57:49.454017",
  "module": "Renewal Module",
  "name": "COF and Suplier Quote",
  "reference_doctype": "Customer Order Form",
  "script": "for d in doc.items:\n    frappe.msgprint(\"hello\")\n    \n    quote_data = frappe.db.sql(f\"\"\"SELECT \n    top.sq_name as name ,\n    (case when top.p_rate IS NOT NULL THEN top.p_rate\n    else 0 END) as purchase_rate,\n    (case when top.p_amount IS NOT NULL THEN top.p_amount\n    else 0 END) as purchase_amount,\n    top.supplier as supplier\n    FROM `tabQuotation Item` tqi\n    LEFT JOIN (SELECT toi.parent as opportunity,toi.name , toi.item_code as s_item_code ,tpq.name as sq_name, tpq.item_code as sq_item_code,\n        toi.rate as s_rate , tpq.rate as p_rate ,tpq.qty as p_qty, tpq.amount as p_amount, tpq.supplier as supplier\n        from \n        `tabOpportunity Item` toi\n        left join (SELECT tsq.name as name , tsq.Supplier as supplier , tsqi.item_code as item_code , tsqi.rate as rate , tsqi.qty as qty, tsqi.amount as amount, tsq.opportunity as opportunity\n        from `tabSupplier Quotation` tsq  \n        left join (SELECT parent , item_code , rate, qty, amount   FROM `tabSupplier Quotation Item`  WHERE recommended_ =1) as tsqi on tsqi.parent = tsq.name \n        ) as tpq on tpq.opportunity = toi.parent and toi.item_code = tpq.item_code) as top on top.opportunity = tqi.prevdoc_docname and top.s_item_code = tqi.item_code \n    WHERE tqi.parent = '{doc.quotation_id}' and tqi.item_code= '{d.item_code}' and tqi.qty ='{d.qty}' ;\"\"\",as_dict =1 )\n    \n    \n    \n\n    \n    # frappe.msgprint(quote_data[])\n    frappe.msgprint(quote_data[0].name)\n    frappe.msgprint(quote_data[0].purchase_rate)\n    frappe.msgprint(quote_data[0].purchase_amount)\n    # frappe.msgprint(\"<pre>{}</pre>\".format(frappe.as_json(quote_data)))\n    frappe.msgprint(\"hi\")\n    old_data = frappe.get_doc('Customer Order Form Item',d.name)\n    old_data.purchase_rate = quote_data[0].purchase_rate\n    old_data.purchase_amount = quote_data[0].purchase_amount\n    old_data.supplier_quotation = quote_data[0].name\n    old_data.supplier = quote_data[0].supplier\n    \n    if quote_data[0].name != \" \":\n        sq_data = frappe.get_doc('Supplier Quotation',quote_data[0].name)\n        sq_data.cof_id = doc.name\n        sq_data.save()\n    else:\n        frappe.throw(f\"Please check Supplier Quotation\")  \n    \n    old_data.save()\n\n# doc.reload()\n    # sold_data.refresh()\n    \n    \n    \n    \n    \n    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-07-12 12:22:52.760055",
  "module": "Renewal Module",
  "name": "Email Group",
  "reference_doctype": "Email Group",
  "script": "if doc.custom_sales_person and doc.custom_based_on == \"Sales User\":\n    filters = {\n        \"user\": doc.custom_sales_person\n    }\n    \n    fields = [\"name\", \"email_id\"]\n    \n    contacts = frappe.get_list(\"Contact\", filters=filters, fields=fields)\n    \n    for con in contacts:\n        if con.email_id:\n            if not frappe.db.exists(\"Email Group Member\", {\"email\": con.email_id}):\n                frappe.get_doc(dict(\n        \t\t    doctype = 'Email Group Member',\n        \t\t    email_group = doc.name,\n        \t\t    email = con.email_id\n        \t    )).insert()\n    \n    filters = {\n        \"email_group\": doc.name\n    }\n    \n    fields = [\"name\"]\n    \n    members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n    \n    doc.total_subscribers = len(members) \n\nif doc.custom_territory and doc.custom_based_on == \"Territory\":\n    s_contacts = frappe.db.sql(f\"\"\"select tc.name,tc.email_id as email  from tabContact tc \n                    left join tabCustomer tc2 on tc.company_name = tc2.name \n                    WHERE tc2.territory = '{doc.custom_territory}' ;\"\"\",as_dict =True)\n                    \n    for each in s_contacts:\n        # frappe.msgprint(each.email)\n        if each.email:\n            if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email}):\n                frappe.get_doc(dict(\n                    doctype= \"Email Group Member\",\n                    email_group = doc.name,\n                    email = each.email,\n                    based_on = doc.custom_territory\n                    )).insert()\n    \n    filters = {\n        \"email_group\": doc.name\n    }\n    \n    fields = [\"name\"]\n    \n    members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n    \n    doc.total_subscribers = len(members)            \n    \nif doc.custom_brand and doc.custom_based_on == \"Brand\":\n    s_contacts = frappe.db.sql(f\"\"\"SELECT tc2.name ,tsi.name , tsii.brand ,tc.email_id as email  FROM tabContact tc inner join `tabDynamic Link` tdl on tdl.parent = tc.name  \n                    left join tabCustomer tc2 on tdl.link_doctype = \"Customer\" and tdl.link_name = tc2.name \n                    LEFT JOIN `tabSales Invoice` tsi on  tsi.customer = tc2.name INNER JOIN `tabSales Invoice Item` tsii on tsi.name =tsii.parent  \n                    WHERE tsii.brand = '{doc.custom_brand}' ;\"\"\",as_dict =True)\n                    \n    for each in s_contacts:\n        # frappe.msgprint(each.email)\n        if each.email:\n            if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email}):\n                frappe.get_doc(dict(\n                    doctype= \"Email Group Member\",\n                    email_group = doc.name,\n                    email = each.email,\n                    based_on = doc.custom_brand\n                    )).insert()\n    \n    filters = {\n        \"email_group\": doc.name\n    }\n    \n    fields = [\"name\"]\n    \n    members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n    \n    doc.total_subscribers = len(members)        \n    \nif doc.custom_industry and doc.custom_based_on == \"Industry\":\n    s_contacts = frappe.db.sql(f\"\"\"select tc.name,tc.email_id as email  from tabContact tc \n                    left join tabCustomer tc2 on tc.company_name = tc2.name \n                    WHERE tc2.industry = '{doc.custom_industry}' ;\"\"\",as_dict =True)\n                    \n    for each in s_contacts:\n        # frappe.msgprint(each.email)\n        if each.email:\n            if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email}):\n                frappe.get_doc(dict(\n                    doctype= \"Email Group Member\",\n                    email_group = doc.name,\n                    email = each.email,\n                    based_on = doc.custom_industry\n                    )).insert()\n    \n    filters = {\n        \"email_group\": doc.name\n    }\n    \n    fields = [\"name\"]\n    \n    members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n    \n    doc.total_subscribers = len(members)            \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-09-28 13:14:45.992365",
  "module": null,
  "name": "Opportunity Status Change",
  "reference_doctype": "Customer Order Form",
  "script": "quote_id = doc.quotation_id\n\nopp_name = frappe.db.sql(f\"\"\"SELECT to2.name as name from `tabQuotation` tq \nleft join `tabOpportunity` to2 on tq.opportunity  = to2.name where tq.name='{doc.quotation_id}';\"\"\", as_dict=1)\nfrappe.msgprint(opp_name[0].name)\nif opp_name[0].name != \" \":\n    data = frappe.get_doc('Opportunity', opp_name[0].name)\n    data.status = \"Partially Closed\"\n    data.save()\n\n# for d in doc.items:\n#     if d.opportunity_type == \"Renewal\":\n#         if d.renewal_id != \" \":\n#             old_data = frappe.get_doc('Renewal List',d.renewal_id)\n#             old_data.status = \"Cofed\"\n#             old_data.save()\n#         else:\n#             frappe.throw(f\"Please check Renewal ID\")    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2024-05-30 11:42:31.380835",
  "module": "orc",
  "name": "ORC Balance Amount",
  "reference_doctype": "Journal Entry",
  "script": "j_amount = 0\nb_amount = 0\n# frappe.msgprint(doc.orc_id)\nif frappe.db.exists({\"doctype\": \"ORC List\", \"name\": doc.orc_id}):\n    orc = doc.orc_id\n    if frappe.db.exists({\"doctype\": \"Journal Entry\", \"orc_id\": doc.orc_id}):\n        je_data = frappe.db.sql(f\"\"\"SELECT total_debit FROM `tabJournal Entry` tje where tje.orc_id = '{orc}' ;\"\"\", as_dict=1)\n        for each in je_data:\n            j_amount = j_amount + each.total_debit\n        \n        data = frappe.get_doc('ORC List', orc)\n        orc_data = frappe.db.sql(f\"\"\"SELECT sub_total FROM `tabORC List` tol where tol.name= '{orc}' ;\"\"\", as_dict=1)\n        b_amount = orc_data[0].sub_total - j_amount\n        data.balance_amount = b_amount\n        if b_amount == 0:\n            data.status = \"Closed\"\n            data.workflow_state=\"Closed\"\n        else:\n            data.status = \"Partially Closed\"\n            orc_data.workflow_state=\"Partially Closed\"\n        data.save()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Delete",
  "event_frequency": "All",
  "modified": "2023-10-10 11:31:18.403581",
  "module": "orc",
  "name": "ORC Balance amount (Delete )",
  "reference_doctype": "Journal Entry",
  "script": "j_amount = 0\nb_amount = 0\nif frappe.db.exists({\"doctype\": \"ORC List\", \"name\": doc.orc_id}):\n    orc = doc.orc_id\n    if frappe.db.exists({\"doctype\": \"Journal Entry\", \"orc_id\": doc.orc_id}):\n        frappe.msgprint(\"exists\")\n        orc_data = frappe.db.sql(f\"\"\"SELECT sub_total FROM `tabORC List` tol where tol.name= '{orc}' ;\"\"\", as_dict=1)\n        je_data = frappe.db.sql(f\"\"\"SELECT total_debit, docstatus FROM `tabJournal Entry` tje where tje.orc_id = '{orc}' and tje.docstatus != '{2}' ;\"\"\", as_dict=1)\n        frappe.msgprint(len(je_data))\n        if len(je_data) < 1:\n            j_amount = orc_data[0].sub_total\n        else:\n            for each in je_data:\n                if each.docstatus != 2:\n                    j_amount = j_amount + each.total_debit\n            \n        data = frappe.get_doc('ORC List', orc)\n        \n        b_amount = orc_data[0].sub_total - j_amount\n        data.balance_amount = b_amount\n        data.save()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-05-24 17:09:02.329298",
  "module": "Renewal Module",
  "name": "Sales person To Target",
  "reference_doctype": "Sales Person",
  "script": "if doc.targets:\n    for each in doc.targets:\n        if frappe.db.exists({\"doctype\": \"Target Details\", \"sales_person\": doc.name, \"fiscal_year\": each.fiscal_year}):\n            name = frappe.db.sql(f\"\"\"SELECT name FROM `tabTarget Details` WHERE sales_person='{doc.name}'AND fiscal_year='{each.fiscal_year}'  ;\"\"\",as_dict=0)\n            old_data = frappe.get_doc('Target Details',name[0][0])\n            old_data.target_amount= each.target_amount\n            old_data.target_type = each.target_type\n            old_data.target_qty = each.target_qty\n            \n            # child_name = frappe.db.sql(f\"\"\"SELECT name FROM `tabTarget Details` WHERE sales_person='{doc.name}'AND fiscal_year='{each.fiscal_year}'  ;\"\"\",as_dict=0)\n            for target in doc.custom_sub_target_details_list:\n                old_data.append(\"sub_targets\",{\n                    'category_type':target.category_type,\n                    'category':target.category,\n                    'fiscal_year':target.fiscal_year,\n                    'target_amount':target.target_amount,\n                    'distribution_id':target.distribution_id,\n                    'target_uom':target.target_uom,\n                    'topline_target':target.topline_target,\n                    'bottomline_target':target.bottomline_target,\n                    'name1':target.name\n                })\n            old_data.save()    \n        else:\n            data = frappe.get_doc({\n                'doctype': 'Target Details',\n                'sales_person':doc.name,\n                'fiscal_year':each.fiscal_year,\n                'target_amount':each.target_amount,\n                'target_qty':each.target_qty,\n                'target_type':each.custom_target_type,\n            })\n            \n            for target in doc.custom_sub_target_details_list:\n                data.append(\"sub_targets\",{\n                    'category_type':target.category_type,\n                    'category':target.category,\n                    'fiscal_year':target.fiscal_year,\n                    'target_amount':target.target_amount,\n                    'distribution_id':target.distribution_id,\n                    'target_uom':target.target_uom,\n                    'topline_target':target.topline_target,\n                    'bottomline_target':target.bottomline_target,\n                    'name1':target.name\n                })\n            data.insert()    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "event_frequency": "All",
  "modified": "2024-05-30 11:14:14.557133",
  "module": null,
  "name": "Invoice To ORC Status",
  "reference_doctype": "Sales Invoice",
  "script": "if doc.items:\n    for each in doc.items:\n        if each.custom_ord_id:\n            orc_data = frappe.get_doc('ORC List',each.custom_orc_id)\n            orc_data.status = \"Waiting For Payment\"\n            orc_data.workflow_state=\"Waiting For Payment\"\n            orc_data.save()\n            frappe.msgprint(\"ORC Status Changed\")\n                ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "event_frequency": "All",
  "modified": "2024-05-28 17:12:02.197379",
  "module": null,
  "name": "Payment Entry To ORC Status",
  "reference_doctype": "Payment Entry",
  "script": "if doc.references:\n    for each in doc.references:\n        # frappe.msgprint(\"Hiiii\")\n        # frappe.msgprint(each.reference_doctype)\n        # frappe.msgprint(each.reference_name)\n        if each.reference_doctype == \"Sales Invoice\" and each.reference_name !=\"\":\n            orc_list = []\n            # frappe.msgprint(\"entered\")\n            sales_invoice = frappe.get_doc('Sales Invoice',each.reference_name)\n            # frappe.db.sql(f\"\"\"SELECT grand_total, outstanding_amount,name FROM `tabSales Invoice` WHERE  name='{each.reference_name}'  ;\"\"\")\n            \n            # frappe.msgprint(\"Hello\")\n            data = sales_invoice.grand_total\n            # frappe.msgprint(data)\n            item_data = frappe.db.sql(f\"\"\"SELECT name,custom_orc_id FROM `tabSales Invoice Item` WHERE  parent='{each.reference_name}'  ;\"\"\",as_dict=1)\n            \n            for i in item_data:\n                if i.custom_orc_id in orc_list:\n                    pass\n                else:\n                    orc_list.append(i.custom_orc_id)\n            # frappe.msgprint(invoice_data[0][1])\n            if len(orc_list) >0 and sales_invoice.outstanding_amount == 0:\n                for r in orc_list:\n                    orc_data = frappe.get_doc('ORC List',r)\n                    orc_data.status = \"Payout\"\n                    orc_data.workflow_state=\"Payout\"\n                    orc_data.save()\n                    frappe.msgprint(\"ORC Status Changed\")\n                ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-08-07 11:44:25.166385",
  "module": null,
  "name": "Email Group Creation",
  "reference_doctype": "Email Group",
  "script": "if doc.custom_filters1:\n    \n    data = frappe.db.sql(f\"\"\"\n        SELECT eg.name, ft.doctypes, ft.field_name, ft.condition, ft.value, ft.and_or_condition\n        FROM `tabEmail Group` AS eg\n        LEFT JOIN `tabFilters Table2` AS ft ON eg.name = ft.parent\n        WHERE eg.name = '{doc.name}' \n    \"\"\")\n    \n    # Process the data to create the formatted string\n    if data:\n        details = []\n        doctype_list = []\n        joins = \"\"\n        for row in data:\n            doctypes = row[1]\n            doctype_list.append(doctypes)\n            field_name = row[2]\n            condition = row[3]\n            value = row[4]\n            and_or = row[5]\n            value= value.replace('\\n', ',')\n            frappe.msgprint(doctypes)\n            # Split values and format them\n            # frappe.msgprint(value.split(','))\n            value_list = [v.strip() for v in value.split(',') if v.strip()]\n            formatted_values = \", \".join([f\"'{v}'\" for v in value_list])\n            details.append(f\" `tab{doctypes}`.{field_name} {condition} ({formatted_values}) {and_or} \")\n            frappe.msgprint(formatted_values)\n            \n            if doctypes == \"Customer\":\n                pass\n            if doctypes == \"Sales Person\":\n                 joins += f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Team`.sales_person\"\n                 frappe.msgprint(joins)\n                \n            if doctypes == \"Opportunity\":\n                joins += f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name  \n                LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctype}`.name\n                \"\"\"\n                \n            if doctypes ==\"Quotation\":\n                joins += f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name \n                LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctype}`.name\n                \"\"\"\n            if doctypes == \"Sales Order\":\n                joins += f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name \n                LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctype}`.name\n                \"\"\"\n            \n            if doctypes ==\"Sales Invoice\":\n                joins += f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name \n                LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctype}`.name\n                \"\"\"\n            if doctypes ==\"Customer Order Form\":\n                joins += f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name \n                LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctype}`.name\n                \"\"\"\n            if doctypes ==\"Renewal List\":\n                joins += f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name \n                LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tab{doctype}`.name\n                LEFT JOIN `tabRenewal Contacts` on `tabRenewal Contacts`.parent = `tab{doctypes}`.name \n                                                \"\"\"\n            if doctypes ==\"Territory\":\n                frappe.msgprint(doctypes)\n                joins += f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.territory \"\n                frappe.msgprint(\"Error\")\n                \n            if doctypes ==\"Industry Type\":\n                joins += f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.industry \"\n                \n            if doctypes ==\"Item\" or \"Sales Invoice\" in doctype_list:\n                joins += f\"\"\"LEFT JOIN `tabSales Invoice` on `tabSales Invoice`.customer  = `tabCustomer`.name \n                                        LEFT JOIN `tabSales Invoice Item` on `tabSales Invoice`.name = `tabSales Invoice Item`.parent\n                                        LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.item_code\"\"\"\n            if doctypes ==\"Item\" and \"Sales Order\" in doctype_list:\n                joins += f\"\"\"LEFT JOIN `tabSales Order` on `tabSales Order`.customer  = `tabCustomer`.name \n                                        LEFT JOIN `tabSales Order Item`  on `tabSales Order`.name = `tabSales Order Item`.parent\n                                        LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.item_code\"\"\"\n            \n            if doctypes ==\"Item\" and \"Renewal List\" in doctype_list: \n                joins += f\"\"\"LEFT JOIN `LEFT JOIN `tabRenewal List`  on `tabRenewal List`.customer_name = `tabCustomer`.name \n                                        LEFT JOIN `tabRenewal Item`  on `tabRenewal Item`.parent = `tabRenewal List`.name \n                                        LEFT JOIN `tabRenewal Contacts`  on `tabRenewal Contacts`.parent = `tabRenewal List`.name \n                                        LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.item_code\"\"\"\n            if doctypes ==\"Brand\" or \"Sales Invoice\" in doctype_list:\n                joins += f\"\"\"LEFT JOIN `tabSales Invoice` on `tabSales Invoice`.customer  = `tabCustomer`.name \n                                        LEFT JOIN `tabSales Invoice Item` on `tabSales Invoice`.name = `tabSales Invoice Item`.parent \n                                        LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.brand\"\"\"\n            if doctypes ==\"Brand\" and \"Sales Order\" in doctype_list:\n                joins += f\"\"\"LEFT JOIN `tabSales Order`  on `tabSales Order`.customer  = `tabCustomer`.name \n                                        LEFT JOIN `tabSales Order Item`  on `tabSales Order`.name = `tabSales Order Item`.parent\n                                        LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.brand\"\"\"\n            \n            if doctypes ==\"Brand\" and \"Renewal List\" in doctype_list: \n                joins += f\"\"\"LEFT JOIN `LEFT JOIN `tabRenewal List`  on `tabRenewal List`.customer_name = `tabCustomer`.name \n                                        LEFT JOIN `tabRenewal Item` on `tabRenewal Item`.parent = `tabRenewal List`.name \n                                        LEFT JOIN `tabRenewal Contacts`  on `tabRenewal Contacts`.parent = `tabRenewal List`.name \n                                        LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.brand\"\"\"\n                                        \n            \n    \n        formatted_output = \" \".join(details)\n        frappe.msgprint(joins)\n        # frappe.msgprint(formatted_output)\n        s_contacts= frappe.db.sql(f\"\"\"SELECT DISTINCT `tabContact`.name, `tabContact`.email_id, `tabCustomer`.territory  from `tabContact` \n                                        left join `tabDynamic Link` on `tabContact`.name = `tabDynamic Link`.parent \n                                        LEFT JOIN `tabCustomer` on `tabDynamic Link`.link_name = `tabCustomer`.name \n                                        LEFT JOIN `tabSales Team` on `tabSales Team`.parent = `tabCustomer`.name \n                                        LEFT JOIN `tabSales Person` on `tabSales Team`.sales_person = `tabSales Person`.name \n                                        {joins }\n                                        WHERE `tabContact`.status = \"Open\" {formatted_output};\"\"\",as_dict =True)\n            \n                                        \n                \n        \n        for each in s_contacts:\n            frappe.msgprint(each.email)\n            if each.email:\n                if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email}):\n                    frappe.get_doc(dict(\n                        doctype= \"Email Group Member\",\n                        email_group = doc.name,\n                        email = each.email,\n                        based_on = doc.custom_territory\n                        )).insert()\n        \n        filters = {\n            \"email_group\": doc.name\n        }\n        \n        fields = [\"name\"]\n        \n        members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n        \n        doc.total_subscribers = len(members)\n        \n    else:\n        frappe.msgprint(\"No data found in the filters table.\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-08-20 14:15:13.841175",
  "module": null,
  "name": "Custom Email Group",
  "reference_doctype": "Custom Email Group",
  "script": "\nif doc.filters_table:\n    data = frappe.db.sql(f\"\"\"\n        SELECT eg.name, ft.doctypes, ft.field_name, ft.condition, ft.value, ft.and_or_condition\n        FROM `tabCustom Email Group` AS eg\n        LEFT JOIN `tabFilters Table1` AS ft ON eg.name = ft.parent\n        WHERE eg.name = %s\n    \"\"\", (doc.name,))\n\n    # Process the data to create the formatted string\n    if data:\n        details = []\n        doctype_list = []\n        joins = \"\"\n        join_list = []\n        for row in data:\n            doctypes = row[1]\n            doctype_list.append(doctypes)\n            field_name = row[2]\n            condition = row[3]\n            value = row[4]\n            and_or = row[5]\n            value = value.replace('\\n', ',')\n            frappe.msgprint(doctypes)\n\n            # Split values and format them\n            value_list = [v.strip() for v in value.split(',') if v.strip()]\n            formatted_values = \", \".join([f\"'{v}'\" for v in value_list])\n            details.append(f\" {and_or} `tab{doctypes}`.{field_name} {condition} ({formatted_values})\")\n            frappe.msgprint(formatted_values)\n\n            # Construct joins based on doctypes\n            if doctypes == \"Customer\":\n                pass\n            # elif doctypes == \"Sales Person\":\n            #     joins += f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Team`.sales_person \"\n            elif doctypes == \"Opportunity\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Quotation\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Sales Order\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Sales Invoice\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Customer Order Form\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n                             \n            elif doctypes == \"Renewal List\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tab{doctypes}`.name\n                             LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Territory\":\n                frappe.msgprint(\"territory\")\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.territory \"\"\")\n            \n            elif doctypes == \"Industry Type\":\n                join_list.append(f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.industry \")\n\n            if doctypes == \"Item\" and \"Sales Invoice\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.item_code \"\"\")\n                \n            if doctypes == \"Item\" and \"Sales Order\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.item_code \"\"\")\n                \n            # if doctypes == \"Item\" and \"Renewal List\" in doctype_list:\n            #     join_list.append(f\"\"\"LEFT JOIN `tabRenewal List` ON `tabRenewal List`.customer_name = `tabCustomer`.name\n            #                  LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tabRenewal List`.name\n            #                  LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tabRenewal List`.name\n            #                  LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.item_code \"\"\")\n            \n            if doctypes == \"Item\" and \"Renewal List\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.item_code \"\"\")\n            \n            \n            \n            \n            if doctypes == \"Brand\" and \"Sales Invoice\" in doctype_list:\n                frappe.msgprint(\"brand\")\n                frappe.msgprint(joins)\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.brand \"\"\")\n                \n            if doctypes == \"Brand\" and \"Sales Order\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.brand \"\"\")\n                \n            if doctypes == \"Brand\" and \"Renewal List\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.brand \"\"\")\n\n        formatted_output = \" \".join(details)\n        join_output = \"\\n \".join(join_list)\n        frappe.msgprint(formatted_output)\n\n        # Fetch contacts based on the joins and conditions\n        s_contacts = frappe.db.sql(f\"\"\"\n            SELECT DISTINCT `tabContact`.name as contact_person, `tabContact`.email_id as email, `tabCustomer`.territory,`tabCustomer`.name as customer\n            FROM `tabContact`\n            LEFT JOIN `tabDynamic Link` ON `tabContact`.name = `tabDynamic Link`.parent\n            LEFT JOIN `tabCustomer` ON `tabDynamic Link`.link_name = `tabCustomer`.name\n            LEFT JOIN `tabSales Team` ON `tabSales Team`.parent = `tabCustomer`.name\n            LEFT JOIN `tabSales Person` ON `tabSales Team`.sales_person = `tabSales Person`.name\n            {join_output}\n            WHERE `tabContact`.status = \"Open\" {formatted_output};\n        \"\"\", as_dict=True)\n        \n        frappe.msgprint(f\"Total contacts found: {len(s_contacts)}\")\n        added_emails = set()\n\n\n        for each in s_contacts:\n            frappe.msgprint(each.email)\n            if each.email and each.email not in added_emails:\n                if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email,\"custom_email_group\": doc.name}):\n                    frappe.get_doc({\n                        \"doctype\": \"Email Group Member\",\n                        \"email_group\": \"Kaspersky Cloud Console Maintainence -1\",\n                        \"custom_email_group\":doc.name,\n                        \"email\": each.email,\n                        \"custom_customer_name\":each.customer,\n                        \"custom_contact_person\":each.contact_person\n                    }).insert()\n                    added_emails.add(each.email)\n\n        filters = {\n            \"custom_email_group\": doc.name\n        }\n\n        fields = [\"name\"]\n\n        members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n\n        doc.total_subscribers = len(members)\n    else:\n        frappe.msgprint(\"No data found in the filters table.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-08-07 12:37:07.096904",
  "module": null,
  "name": "Email Group Testing",
  "reference_doctype": "Email Group",
  "script": "\nif doc.custom_filters1:\n    data = frappe.db.sql(f\"\"\"\n        SELECT eg.name, ft.doctypes, ft.field_name, ft.condition, ft.value, ft.and_or_condition\n        FROM `tabEmail Group` AS eg\n        LEFT JOIN `tabFilters Table2` AS ft ON eg.name = ft.parent\n        WHERE eg.name = %s\n    \"\"\", (doc.name,))\n\n    # Process the data to create the formatted string\n    if data:\n        details = []\n        doctype_list = []\n        joins = \"\"\n        join_list = []\n        for row in data:\n            doctypes = row[1]\n            doctype_list.append(doctypes)\n            field_name = row[2]\n            condition = row[3]\n            value = row[4]\n            and_or = row[5]\n            value = value.replace('\\n', ',')\n            frappe.msgprint(doctypes)\n\n            # Split values and format them\n            value_list = [v.strip() for v in value.split(',') if v.strip()]\n            formatted_values = \", \".join([f\"'{v}'\" for v in value_list])\n            details.append(f\" {and_or} `tab{doctypes}`.{field_name} {condition} ({formatted_values})\")\n            frappe.msgprint(formatted_values)\n\n            # Construct joins based on doctypes\n            if doctypes == \"Customer\":\n                pass\n            # elif doctypes == \"Sales Person\":\n            #     joins += f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Team`.sales_person \"\n            elif doctypes == \"Opportunity\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Quotation\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Sales Order\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Sales Invoice\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Customer Order Form\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tab{doctypes} Item` ON `tab{doctypes} Item`.parent = `tab{doctypes}`.name \"\"\")\n            elif doctypes == \"Renewal List\":\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tab{doctypes}`.name\n                             LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tab{doctypes}`.name \"\"\")\n            \n            elif doctypes == \"Territory\":\n                frappe.msgprint(\"territory\")\n                join_list.append(f\"\"\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.territory \"\"\")\n            \n            elif doctypes == \"Industry Type\":\n                join_list.append(f\"LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabCustomer`.industry \")\n\n            if doctypes == \"Item\" or \"Sales Invoice\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tabSales Invoice` ON `tabSales Invoice`.customer = `tabCustomer`.name\n                             LEFT JOIN `tabSales Invoice Item` ON `tabSales Invoice`.name = `tabSales Invoice Item`.parent\n                             LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.item_code \"\"\")\n            if doctypes == \"Item\" and \"Sales Order\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tabSales Order` ON `tabSales Order`.customer = `tabCustomer`.name\n                             LEFT JOIN `tabSales Order Item` ON `tabSales Order`.name = `tabSales Order Item`.parent\n                             LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.item_code \"\"\")\n            if doctypes == \"Item\" and \"Renewal List\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tabRenewal List` ON `tabRenewal List`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tabRenewal List`.name\n                             LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tabRenewal List`.name\n                             LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.item_code \"\"\")\n            \n            \n            if doctypes == \"Brand\" or \"Sales Invoice\" in doctype_list:\n                frappe.msgprint(\"brand\")\n                frappe.msgprint(joins)\n                join_list.append(f\"\"\"LEFT JOIN `tabSales Invoice` ON `tabSales Invoice`.customer = `tabCustomer`.name\n                             LEFT JOIN `tabSales Invoice Item` ON `tabSales Invoice`.name = `tabSales Invoice Item`.parent\n                             LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Invoice Item`.brand \"\"\")\n            if doctypes == \"Brand\" and \"Sales Order\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tabSales Order` ON `tabSales Order`.customer = `tabCustomer`.name\n                             LEFT JOIN `tabSales Order Item` ON `tabSales Order`.name = `tabSales Order Item`.parent\n                             LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabSales Order Item`.brand \"\"\")\n            if doctypes == \"Brand\" and \"Renewal List\" in doctype_list:\n                join_list.append(f\"\"\"LEFT JOIN `tabRenewal List` ON `tabRenewal List`.customer_name = `tabCustomer`.name\n                             LEFT JOIN `tabRenewal Item` ON `tabRenewal Item`.parent = `tabRenewal List`.name\n                             LEFT JOIN `tabRenewal Contacts` ON `tabRenewal Contacts`.parent = `tabRenewal List`.name\n                             LEFT JOIN `tab{doctypes}` ON `tab{doctypes}`.name = `tabRenewal Item`.brand \"\"\")\n\n        formatted_output = \" \".join(details)\n        join_output = \"\\n \".join(join_list)\n        frappe.msgprint(formatted_output)\n\n        # Fetch contacts based on the joins and conditions\n        s_contacts = frappe.db.sql(f\"\"\"\n            SELECT DISTINCT `tabContact`.name as contact_person, `tabContact`.email_id as email, `tabCustomer`.territory,`tabCustomer`.name as customer\n            FROM `tabContact`\n            LEFT JOIN `tabDynamic Link` ON `tabContact`.name = `tabDynamic Link`.parent\n            LEFT JOIN `tabCustomer` ON `tabDynamic Link`.link_name = `tabCustomer`.name\n            LEFT JOIN `tabSales Team` ON `tabSales Team`.parent = `tabCustomer`.name\n            LEFT JOIN `tabSales Person` ON `tabSales Team`.sales_person = `tabSales Person`.name\n            {join_output}\n            WHERE `tabContact`.status = \"Open\" {formatted_output};\n        \"\"\", as_dict=True)\n        \n        frappe.msgprint(f\"Total contacts found: {len(s_contacts)}\")\n        added_emails = set()\n\n\n        for each in s_contacts:\n            frappe.msgprint(each.email)\n            if each.email and each.email not in added_emails:\n                if not frappe.db.exists(\"Email Group Member\", {\"email\": each.email,\"email_group\": doc.name}):\n                    frappe.get_doc({\n                        \"doctype\": \"Email Group Member\",\n                        \"email_group\": doc.name,\n                        \"email\": each.email,\n                        \"custom_customer_name\":each.customer,\n                        \"custom_contact_person\":each.contact_person\n                    }).insert()\n                    added_emails.add(each.email)\n\n        filters = {\n            \"email_group\": doc.name\n        }\n\n        fields = [\"name\"]\n\n        members = frappe.get_list(\"Email Group Member\", filters=filters, fields=fields)\n\n        doc.total_subscribers = len(members)\n    else:\n        frappe.msgprint(\"No data found in the filters table.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "event_frequency": "All",
  "modified": "2024-08-12 12:42:44.866424",
  "module": null,
  "name": "Opportunity",
  "reference_doctype": "Opportunity",
  "script": "def get_permission_query_conditions(user):\r\n    if not user: user = frappe.session.user\r\n    \r\n    # Customize this for your Sales Managers\r\n    allowed_sales_persons = []\r\n    if user == \"geetha.p@64network.com\":  # Replace with User A's email/username\r\n        allowed_sales_persons = [\"Sowrya Saragadda Baby\"]\r\n    elif user == \"user_d@example.com\":  # Replace with another user's email/username\r\n        allowed_sales_persons = [\"E\", \"F\"]\r\n    else:\r\n        return \"\"\r\n    \r\n    if allowed_sales_persons:\r\n        condition = \"\"\"(`tabOpportunity`.sales_person IN ({persons}))\"\"\".format(\r\n            persons=\",\".join([\"'{0}'\".format(p) for p in allowed_sales_persons])\r\n        )\r\n        print(f\"Condition: {condition}\")  # Add print statements to debug\r\n        return condition\r\n    return \"\"\r\n\r\n\r\n\r\n# Server Script (Python) - Validate user access based on sales person\r\n# frappe.db.add_custom_fields('Opportunity', {\r\n#     'is_visible': frappe.get_all('Opportunity', filters={\r\n#         'sales_person': ['in', ['Sowrya Saragadda Baby']],\r\n#         'owner': frappe.session.user\r\n#     }, fields=['name'])\r\n# })\r\n",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "event_frequency": "All",
  "modified": "2024-09-17 11:32:48.660733",
  "module": null,
  "name": "Cof Status Update",
  "reference_doctype": "Customer Order Form",
  "script": "\r\nquotation_id = frappe.db.get_value('Customer Order Form', {'name': doc.name}, 'quotation_id')\r\n\r\nif quotation_id:\r\n    if frappe.db.exists('Quotation', quotation_id):\r\n        frappe.db.set_value('Quotation', quotation_id, 'status', 'COF')\r\n        #frappe.msgprint(f\"Quotation {quotation_id} status updated to COF.\")\r\n    else:\r\n        frappe.throw(f\"Quotation with ID {quotation_id} not found.\")\r\nelse:\r\n    frappe.throw(\"No Quotation ID linked with this Customer Order Form.\")\r\n\r\n\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "event_frequency": "All",
  "modified": "2024-09-18 18:28:43.542438",
  "module": "Renewal Module",
  "name": "Quote to Renewal Status",
  "reference_doctype": "Quotation",
  "script": "if doc.items:\n    for d in doc.items:\n        if d.opportunity_type in [\"Renewal\",\"Upgrade\"]:\n            if d.renewal_id != \" \":\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                old_data.status = \"Quoted\"\n                old_data.save()\n            else:\n                frappe.throw(f\"Please check Renewal ID\") \n            # if d.custom_renewal_list:\n            #     for each in d.custom_renewal_list:\n                    \n        \n     ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "event_frequency": "All",
  "modified": "2024-09-18 17:18:42.284921",
  "module": "Renewal Module",
  "name": "Quote Cancel - Renewal Status",
  "reference_doctype": "Quotation",
  "script": "if doc.items:\n    for d in doc.items:\n        if d.opportunity_type in [\"Renewal\",\"Upgrade\"]:\n            if d.renewal_id != \" \":\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                old_data.status = \"Active\"\n                old_data.save()\n            else:\n                frappe.throw(f\"Please check Renewal ID\") \n        \n     ",
  "script_type": "DocType Event"
 }
]