[
 {
  "allow_guest": 0,
  "api_method": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-04-06 11:30:06.320105",
  "module": "Renewal Module",
  "name": "Sales Invoice to Renewal",
  "reference_doctype": "Sales Invoice",
  "script": "invoice_num = doc.name\nuser = \"\"\nteam_name= \"\"\n#frappe.msgprint(doc.customer_name)\n\nif doc.sales_team.length != 0:\n    user = doc.sales_team[0].sales_person\n    team_name = doc.sales_team[0].team_name\n\n\n    \nfor d in doc.items:\n    frappe.msgprint(d.item_name)\n     \n    if d.newadd == \"Renewal\":\n       \n        if frappe.db.exists({\"doctype\": \"Renewal List\", \"customer_name\": doc.customer_name, \"product_name\": d.item_name, \"status\":\"Active\"}):\n            frappe.msgprint(doc.customer_name)\n            status_item = \"Active\"\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE status='{status_item}'AND product_name='{d.item_name}' AND customer_name='{doc.customer_name}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Renewed\"\n            old_data.save()\n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n        \n            \n            contact_status = \"Open\"\n            contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n            \n            \n            sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name, account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n            frappe.msgprint(sales_team[0][0])\n            frappe.msgprint(sales_team[0][1])\n            if renewal_option:\n                frappe.msgprint(renewal_option[0][0])\n            \n                if renewal_option[0][0] == \"Yes\":\n                    data = frappe.get_doc({\n                        'doctype': 'Renewal List',\n                        'product_name':d.item_code,\n                        'status':\"Active\",\n                        'invoice_no':invoice_num,\n                        'end_date':d.end_date,\n                        'total_quantity':d.qty,\n                        'total_amount':d.amount,\n                        'start_date':d.start_date,\n                        'customer_name':doc.customer,\n                        'sales_user' : user,\n                        'sales_team' : team_name,\n                        'renewal_owner':sales_team[0][2]\n                        \n                        \n                    })\n                    frappe.msgprint(d.item_code)\n                    \n                    data.append(\"items\",{\n                        'item_code' : d.item_code,\n                        'qty': d.qty,\n                        'start_date':d.start_date,\n                        'end_date':d.end_date,\n                        'rate':d.rate,\n                        'new_add':d.newadd,\n                        'amount':d.amount,\n                        'uom':d.uom,\n                        'description':d.description,\n                        'item_name': d.item_name,\n                        'invoice_no':invoice_num,\n                        'conversion_factor':d.conversion_factor\n                    })\n                    \n                    \n                    \n                    for each in doc.contact_list:\n                    \n                        data.append(\"contact_list\",{\n                            'user_name' : each.user_name,\n                            'mobile_no': each.mobile_no,\n                            'email_id':each.email_id,\n                            'designation':each.designation\n                            \n                        })\n                        \n                    data.insert()    \n        \n        \n        else:\n            frappe.throw(f\"Renewal item {d.item_name} is not available\")            \n    \n    \n    if d.newadd == \"Additional\":\n        if frappe.db.exists({\"doctype\": \"Renewal List\", \"customer_name\": doc.customer_name, \"product_name\": d.item_name, \"status\":\"Active\"}):\n            frappe.msgprint(doc.customer_name)\n            \n            status_item = \"Active\"\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE status='{status_item}' AND product_name='{d.item_name}' AND customer_name='{doc.customer_name}'  ;\"\"\")\n            \n            frappe.msgprint(name_field[0][0])\n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            # frappe.msgprint(old_data)\n            old_data.status = \"Active\"\n            old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n            old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n            \n            old_data.append(\"items\",{\n                'item_code' : d.item_code,\n                'qty': d.qty,\n                'start_date':d.start_date,\n                'end_date':d.end_date,\n                'rate':d.rate,\n                'new_add':d.newadd,\n                'amount':d.amount,\n                'uom':d.uom,\n                'cost_center':d.cost_center,\n                'description':d.description,\n                'item_name': d.item_name,\n                'invoice_no':doc.name,\n                'conversion_factor':d.conversion_factor\n            })\n            frappe.msgprint(\"Successfully entered Renewal\")\n            #old_data.insert()\n            old_data.save()\n            \n        else:\n            frappe.throw(f\"Please check line item {d.item_name}\")  \n            \n    if d.newadd == \"New\":\n        \n        renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n        \n        #frappe.msgprint(renewal_option[0])\n        contact_status = \"Open\"\n        contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n        # frappe.msgprint(len(contact_data))\n        \n        sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name,account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n        #frappe.msgprint(sales_team[0][0])\n        #frappe.msgprint(sales_team[0][1])\n        if renewal_option:\n            #frappe.msgprint(renewal_option[0][0])\n        \n            if renewal_option[0][0] == \"Yes\":\n                \n                \n                data = frappe.get_doc({\n                    'doctype': 'Renewal List',\n                    'product_name':d.item_name,\n                    'status':\"Active\",\n                    'invoice_no':invoice_num,\n                    'end_date':d.end_date,\n                    'total_quantity':d.qty,\n                    'total_amount':d.amount,\n                    'start_date':d.start_date,\n                    'customer_name':doc.customer,\n                    'sales_user' : user,\n                    'sales_team' : team_name,\n                    'renewal_owner':sales_team[0][2]\n                    \n                    \n                })\n                \n                    \n                #frappe.msgprint(d.item_code)\n                \n                data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':invoice_num,\n                    'conversion_factor':d.conversion_factor,\n                    'managed_services':d.managed_services\n                })\n                \n                for each in doc.contact_list:\n                    \n                    data.append(\"contact_list\",{\n                        'user_name' : each.user_name,\n                        'mobile_no': each.mobile_no,\n                        'email_id':each.email_id,\n                        'designation':each.designation,\n                        \n                    })\n                    \n                    frappe.msgprint(\"Successfully entered Renewal\")\n               \n                \n                \n                data.insert() \n        \n        else:\n            frappe.msgprint(\"This product has no subscription\")\n                \n                \n                \n                    \n            \n         ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-04-03 17:52:32.924392",
  "module": "Renewal Module",
  "name": "Invoice to Renewal",
  "reference_doctype": "Sales Invoice",
  "script": "invoice_num = doc.name\nuser = \"\"\nlead_name= \"\"\nfrappe.msgprint(doc.customer_name)\n\nif doc.sales_team.length != 0:\n    user = doc.sales_team[0].sales_person\n    lead_name = doc.sales_team[0].team_name\n\n\nif doc.is_return == 0:\n    for d in doc.items:\n        frappe.msgprint(d.newadd)\n         \n        if d.newadd == \"Renewal\" :\n            if d.renewal_id != \" \":\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                #frappe.msgprint(\"hello hi hi\")\n                \n                old_data.status = \"Renewed\"\n                old_data.save()\n                renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n                \n                #frappe.msgprint(renewal_option[0])\n                contact_status = \"Open\"\n                contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n                # frappe.msgprint(len(contact_data))\n                \n                sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n                frappe.msgprint(sales_team[0][0])\n                #frappe.msgprint(sales_team[0][1])\n                if renewal_option:\n                    frappe.msgprint(renewal_option[0][0])\n            \n                    if renewal_option[0][0] == \"Yes\":\n                        data = frappe.get_doc({\n                            'doctype': 'Renewal List',\n                            'product_name':d.item_name,\n                            'status':\"Active\",\n                            'invoice_no':invoice_num,\n                            'end_date':d.end_date,\n                            'total_quantity':d.qty,\n                            'total_amount':doc.grand_total,\n                            'start_date':d.start_date,\n                            'customer_name':doc.customer,\n                            'sales_user' : user,\n                            'sales_team' : lead_name\n                            \n                            \n                        })\n                        frappe.msgprint(d.item_code)\n                        \n                        data.append(\"items\",{\n                            'item_code' : d.item_code,\n                            'qty': d.qty,\n                            'start_date':d.start_date,\n                            'end_date':d.end_date,\n                            'rate':d.rate,\n                            'new_add':d.newadd,\n                            'amount':d.amount,\n                            'uom':d.uom,\n                            'description':d.description,\n                            'item_name': d.item_name,\n                            'invoice_no':invoice_num,\n                            'conversion_factor':d.conversion_factor\n                        })\n                        \n                        #frappe.msgprint(\"auto-entered\")\n                        \n                       \n                        \n                        for each in doc.contact_list:\n                        \n                            data.append(\"contact_list\",{\n                                'user_name' : each.user_name,\n                                'mobile_no': each.mobile_no,\n                                'email_id':each.email_id,\n                                'designation':each.designation\n                                \n                            })\n                            \n                        data.insert()    \n                \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n           \n        if d.newadd == \"Additional\" :\n            if d.renewal_id != \" \":\n                #frappe.msgprint(name_field[0][0])\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                # frappe.msgprint(old_data)\n                old_data.status = \"Active\"\n                old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n                old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n                \n                old_data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'cost_center':d.cost_center,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':doc.name,\n                    'conversion_factor':d.conversion_factor\n                })\n                #old_data.insert()\n                old_data.save()\n            \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n        \n        if d.newadd == \"New\":\n            \n            renewal_option = frappe.db.sql(f\"\"\"SELECT renewal_option FROM `tabItem` WHERE  name='{d.item_code}'  ;\"\"\")\n            \n            #frappe.msgprint(renewal_option[0])\n            contact_status = \"Open\"\n            contact_data = frappe.db.sql(f\"\"\"SELECT name FROM `tabContact` WHERE  company_name='{doc.customer_name}' AND status='{contact_status}'  ;\"\"\")\n            # frappe.msgprint(len(contact_data))\n            \n            sales_team = frappe.db.sql(f\"\"\"SELECT sales_person, team_name,account_manager FROM `tabCustomer` WHERE  customer_name='{doc.customer_name}'  ;\"\"\")\n            frappe.msgprint(sales_team[0][0])\n            frappe.msgprint(sales_team[0][1])\n            if renewal_option:\n                frappe.msgprint(renewal_option[0][0])\n            \n                if renewal_option[0][0] == \"Yes\":\n                    \n                    \n                    data = frappe.get_doc({\n                        'doctype': 'Renewal List',\n                        'product_name':d.item_name,\n                        'status':\"Active\",\n                        'invoice_no':invoice_num,\n                        'end_date':d.end_date,\n                        'total_quantity':d.qty,\n                        'total_amount':d.amount,\n                        'start_date':d.start_date,\n                        'customer_name':doc.customer,\n                        'sales_user' : user,\n                        'sales_team' : lead_name,\n                        'renewal_owner':sales_team[0][2]\n                        \n                    \n                    \n                    \n                        \n                        \n                    })\n                    \n                        \n                    frappe.msgprint(d.item_code)\n                    \n                    data.append(\"items\",{\n                        'item_code' : d.item_code,\n                        'qty': d.qty,\n                        'start_date':d.start_date,\n                        'end_date':d.end_date,\n                        'rate':d.rate,\n                        'new_add':d.newadd,\n                        'amount':d.amount,\n                        'uom':d.uom,\n                        'description':d.description,\n                        'item_name': d.item_name,\n                        'invoice_no':invoice_num,\n                        'conversion_factor':d.conversion_factor,\n                        'managed_services':d.managed_services\n                    })\n                    \n                    for each in doc.contact_list:\n                        \n                        data.append(\"contact_list\",{\n                            'user_name' : each.user_name,\n                            'mobile_no': each.mobile_no,\n                            'email_id':each.email_id,\n                            'designation':each.designation,\n                            \n                        })\n                        \n                        frappe.msgprint(\"contact-entered\")\n                    \n                    frappe.msgprint(\"re-entered\")\n                    \n                   \n                    \n                    \n                    data.insert() \nelse:\n    for d in doc.items:\n        if d.newadd == \"New\":\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Void\"\n            old_data.save()\n        if d.newadd == \"Renewal\":\n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal List` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data = frappe.get_doc('Renewal List',name_field[0][0])\n            \n            old_data.status = \"Void\"\n            old_data.save()\n        if d.newadd == \"Additional\"   : \n            name_field = frappe.db.sql(f\"\"\"SELECT name FROM `tabRenewal Item` WHERE invoice_no='{doc.return_against}'  ;\"\"\",as_dict=0)\n            \n            \n            old_data1 = frappe.get_doc('Renewal Item',name_field[0][0])\n            \n            old_data1.status = \"Void\"\n            old_data1.save()  \n            if d.renewal_id != \" \":\n                #frappe.msgprint(name_field[0][0])\n                old_data = frappe.get_doc('Renewal List',d.renewal_id)\n                # frappe.msgprint(old_data)\n                old_data.status = \"Active\"\n                old_data.total_amount = int(old_data.total_amount) + int(d.amount)\n                old_data.total_quantity = int(old_data.total_quantity) + int(d.qty)\n                \n                old_data.append(\"items\",{\n                    'item_code' : d.item_code,\n                    'qty': d.qty,\n                    'start_date':d.start_date,\n                    'end_date':d.end_date,\n                    'rate':d.rate,\n                    'new_add':d.newadd,\n                    'amount':d.amount,\n                    'uom':d.uom,\n                    'cost_center':d.cost_center,\n                    'description':d.description,\n                    'item_name': d.item_name,\n                    'invoice_no':doc.name,\n                    'status':\"Void\",\n                    'conversion_factor':d.conversion_factor\n                })\n                #old_data.insert()\n                old_data.save()\n            \n            else:\n                frappe.throw(f\"Please check Renewal ID\")\n     ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "event_frequency": "All",
  "modified": "2023-04-03 12:13:49.341595",
  "module": "Renewal Module",
  "name": "cof to renewal status",
  "reference_doctype": "Customer Order Form",
  "script": "for d in doc.items:\n    if d.opportunity_type == \"Additional\" or d.opportunity_type == \"Renewal\":\n        if d.renewal_id != \" \":\n            old_data = frappe.get_doc('Renewal List',d.renewal_id)\n            old_data.status = \"Cofed\"\n            old_data.save()\n        else:\n            frappe.throw(f\"Please check Renewal ID\")    \n        \n     ",
  "script_type": "DocType Event"
 }
]